"use strict";var ApplicationConfiguration=function(){var applicationModuleName="justfix",applicationModuleVendorDependencies=["ngResource","ngAnimate","ngCookies","ui.router","ui.bootstrap","ui.select","ui.utils","ng.deviceDetector","ngFileUpload","bootstrapLightbox","angularLazyImg","duScroll","pascalprecht.translate","tmh.dynamicLocale"],registerModule=function(moduleName,dependencies){angular.module(moduleName,dependencies||[]),angular.module(applicationModuleName).requires.push(moduleName)};return{applicationModuleName:applicationModuleName,applicationModuleVendorDependencies:applicationModuleVendorDependencies,registerModule:registerModule}}();angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider",function($locationProvider){$locationProvider.hashPrefix("!"),$locationProvider.html5Mode(!0)}]).config(["$compileProvider",function($compileProvider){$compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|tel|sms|mailto):/)}]).constant("LOCALES",{locales:{en_US:"English",es:"Español"},preferredLocale:"en_US"}).config(["$translateProvider",function($translateProvider){$translateProvider.useMissingTranslationHandlerLog()}]).config(["$translateProvider",function($translateProvider){$translateProvider.useStaticFilesLoader({prefix:"languages/locale-",suffix:".json"}),$translateProvider.preferredLanguage("en_US"),$translateProvider.useLocalStorage()}]).config(["tmhDynamicLocaleProvider",function(tmhDynamicLocaleProvider){tmhDynamicLocaleProvider.localeLocationPattern("lib/angular-i18n/angular-locale_{{locale}}.js")}]).run(function(){Array.prototype.containsByKey=Array.prototype.containsByKey||function(key){var i,l=this.length;for(i=0;l>i;i++)if(this[i].key==key)return!0;return!1},Array.prototype.getByKey=Array.prototype.getByKey||function(key){var i,l=this.length;for(i=0;l>i;i++)if(this[i].key==key)return this[i];return null},Array.prototype.removeByKey=Array.prototype.removeByKey||function(key){var i,l=this.length;for(i=l-1;i>=0;i--)this[i].key==key&&this.splice(i,1)}}).run(["$rootScope",function($rootScope){var setHeaderState=function(name){switch(name){case"landing":$rootScope.headerInner=!1,$rootScope.headerLightBG=!1;break;case"manifesto":$rootScope.headerInner=!1,$rootScope.headerLightBG=!0;break;default:$rootScope.headerInner=!0,$rootScope.headerLightBG=!1}};$rootScope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){$rootScope.state=toState.name,setHeaderState(toState.name)})}]),angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),FastClick&&FastClick.attach(document.body),angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])}),ApplicationConfiguration.registerModule("actions"),ApplicationConfiguration.registerModule("activity"),ApplicationConfiguration.registerModule("admin"),ApplicationConfiguration.registerModule("core"),ApplicationConfiguration.registerModule("findhelp"),ApplicationConfiguration.registerModule("issues"),ApplicationConfiguration.registerModule("kyr"),ApplicationConfiguration.registerModule("onboarding"),ApplicationConfiguration.registerModule("problems"),ApplicationConfiguration.registerModule("tutorial"),ApplicationConfiguration.registerModule("users"),angular.module("actions").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$stateProvider.state("listActions",{url:"/take-action",templateUrl:"modules/actions/views/list-actions.client.view.html",data:{"protected":!0}})}]),angular.module("actions").controller("ActionsController",["$scope","$filter","Authentication","Actions","Activity",function($scope,$filter,Authentication,Actions,Activity){$scope.user=Authentication.user,$scope.userCompletedDetails=function(){return $scope.user.actionFlags?-1!==$scope.user.actionFlags.indexOf("allInitial"):!1},$scope.list=function(){Actions.query(function(actions){$scope.onceActions=$filter("filter")(actions,{$:"once"},!0),$scope.recurringActions=$filter("filter")(actions,{$:"recurring"},!0),$scope.legalActions=$filter("filter")(actions,{$:"legal"},!0)})}}]),angular.module("actions").controller("AddDetailsController",["$scope","$filter","$modalInstance","newActivity","Problems",function($scope,$filter,$modalInstance,newActivity,Problems,close){$scope.newActivity=newActivity,$scope.issues=Problems.getUserIssuesByKey($scope.newActivity.key),$scope.newActivity.problems=[{issues:JSON.parse(JSON.stringify($scope.issues,function(key,value){return"$$hashKey"!==key&&"_id"!==key?value:void 0}))}],$scope.formSubmitted=!1,$scope.onFileSelect=function(files){console.log(files)},$scope.done=function(isValid){$scope.formSubmitted=!0,isValid&&($scope.newActivity.fields.push({title:"First experienced on:",value:$filter("date")($scope.newActivity.startDate,"longDate")}),$modalInstance.close({newActivity:$scope.newActivity}))},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}]),angular.module("actions").controller("ComplaintLetterController",["$rootScope","$scope","$sce","$timeout","$modalInstance","newActivity","Pdf","Authentication","$window",function($rootScope,$scope,$sce,$timeout,$modalInstance,newActivity,Pdf,Authentication,$window){$scope.newActivity=newActivity,$scope.newActivity.fields=[],$scope.landlord={name:"",address:""},$scope.accessDates=[],$scope.accessDates.push(""),$scope.status={loading:!1,created:!1,error:!1},$scope.addAccessDate=function(){$scope.accessDates.push("")};var timerCountdown=30,setCreationTimer=function(){$timeout(function(){$scope.status.created||($scope.status.loading=!1,$scope.status.error=!0,$scope.errorCode="Request for the letter took too long to respond")},1e3*timerCountdown)};$scope.createLetter=function(){$scope.status.loading=!0,Pdf.createComplaint($scope.landlord,$scope.accessDates).then(function(data){setCreationTimer(),$scope.status.loading=!1,$scope.status.created=!0,$scope.letterUrl=data,$scope.newActivity.fields.push({title:"letterURL",value:data})},function(error){$scope.status.loading=!1,$scope.status.error=!0,$scope.errorCode=error})},$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.done=function(){$modalInstance.close({newActivity:$scope.newActivity,modalError:$scope.status.error})}}]),angular.module("actions").controller("ContactSuperController",["$scope","$modalInstance","deviceDetector","Messages","newActivity",function($scope,$modalInstance,deviceDetector,Messages,newActivity){$scope.newActivity=newActivity,$scope.formSubmitted=!1,$scope.done=function(isValid,event){$scope.formSubmitted=!0,isValid&&($modalInstance.close({newActivity:$scope.newActivity}),console.log(event.target.href),window.location.href=event.target.href)},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}]),angular.module("actions").controller("DecreasedServicesController",["$scope","$modalInstance","newActivity",function($scope,$modalInstance,newActivity){$scope.newActivity=newActivity,$scope.addUpdate=function(){$modalInstance.close({newActivity:$scope.newActivity})},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}]),angular.module("actions").controller("HpactionController",["$scope","$modalInstance","newActivity",function($scope,$modalInstance,newActivity){$scope.newActivity=newActivity,$scope.done=function(){$modalInstance.close({newActivity:$scope.newActivity})},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}]),angular.module("actions").controller("MessageLandlordController",["$scope","$modalInstance","Messages","newActivity",function($scope,$modalInstance,Messages,newActivity){$scope.newActivity=newActivity,$scope.email={},$scope.email.content=Messages.getLandlordEmailMessage(),$scope.done=function(){$scope.email.contact=$scope.email.landlord+"?subject="+Messages.getLandlordEmailSubject(),$scope.emailHref="mailto:"+encodeURI($scope.email.contact+"&body="+$scope.email.content),$modalInstance.close({newActivity:$scope.newActivity}),window.location.href=$scope.emailHref},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}]),angular.module("actions").controller("RentalHistoryController",["$scope","$modalInstance","Messages","newActivity",function($scope,$modalInstance,Messages,newActivity){$scope.newActivity=newActivity,$scope.emailContent=Messages.getRentalHistoryMessage(),$scope.emailHref="mailto:"+encodeURI("rentinfo@nyshcr.org?subject=Request For Rental History&body="+$scope.emailContent),$scope.done=function(){$modalInstance.close({newActivity:$scope.newActivity}),window.location.href=$scope.emailHref},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}]),angular.module("actions").directive("compileTemplate",["$compile","$parse",function($compile,$parse){return{link:function(scope,element,attr){var parsed=$parse(attr.ngBindHtml),getStringValue=function(){return(parsed(scope)||"").toString()};scope.$watch(getStringValue,function(){$compile(element,null,-9999)(scope)})}}}]),angular.module("actions").directive("statusUpdate",["$rootScope","$filter","$sce","$timeout","Activity","Actions","Problems",function($rootScope,$filter,$sce,$timeout,Activity,Actions,Problems){return{restrict:"E",templateUrl:"modules/actions/partials/status-update.client.view.html",controller:["$scope","$element","$attrs",function($scope,$element,$attrs){}],link:function(scope,element,attrs){scope.problems=Problems.getUserProblems(),scope.status={expanded:!1,tagging:!1,closeAlert:!1,closeErrorAlert:!0,formSubmitted:!1,completed:!1},scope.newActivity={date:"",title:"Status Update",key:"statusUpdate",relatedProblems:[],photos:[]},scope.expand=function(event){event.preventDefault(),scope.status.expanded=!0},scope.toggleTagging=function(){scope.status.tagging=!scope.status.tagging},scope.selectProblem=function(problem){if(this.isSelectedProblem(problem)){var i=scope.newActivity.relatedProblems.indexOf(problem);scope.newActivity.relatedProblems.splice(i,1)}else scope.newActivity.relatedProblems.push(problem)},scope.isSelectedProblem=function(problem){return-1!==scope.newActivity.relatedProblems.indexOf(problem)},scope.addPhoto=function(file){file&&(scope.newActivity.photos.push(file),console.log(file),console.log(file.lastModifiedDate),file.lastModifiedDate&&(scope.newActivity.date=file.lastModifiedDate))},scope.closeAlert=function(){scope.status.closeAlert=!0},scope.createActivity=function(isValid){if(scope.status.formSubmitted=!0,isValid){$rootScope.loading=!0,console.log("create activity pre creation",scope.newActivity);var activity=new Activity(scope.newActivity);console.log("create activity post creation",scope.newActivity),activity.$save(function(response){console.log("create activity post save",response),$rootScope.loading=!1,scope.status.completed=!0,scope.status.formSubmitted=!1,scope.status.expanded=!1,scope.newActivity={date:"",title:"Status Update",key:"statusUpdate",relatedProblems:[],photos:[]}},function(errorResponse){$rootScope.loading=!1,scope.error=errorResponse.data.message,scope.status.closeErrorAlert=!1})}}}}}]),angular.module("actions").directive("toDoItem",["$rootScope","$modal","$sce","$compile","$filter","$timeout","Authentication","Activity","Actions",function($rootScope,$modal,$sce,$compile,$filter,$timeout,Authentication,Activity,Actions){return{restrict:"E",templateUrl:"modules/actions/partials/to-do-item.client.view.html",controller:["$scope","$element","$attrs",function($scope,$element,$attrs){$scope.filterTitleHTML=function(){return $sce.trustAsHtml($scope.action.title)},$scope.filterContentHTML=function(){return $sce.trustAsHtml($scope.action.content)},$scope.filterButtonTitleHTML=function(){return $sce.trustAsHtml($scope.action.cta.buttonTitle)},$scope.closeErrorAlert=!0}],link:function(scope,element,attrs){scope.followUpSubmitted=!1,scope.action.completed||(scope.action.completed=!1),scope.newActivity={title:scope.action.activityTitle,key:scope.action.key},scope.action.isFollowUp&&scope.action.startDate&&(scope.newActivity.startDate=new Date(scope.action.startDate)),scope.newActivity.fields=[],scope.action.followUp&&scope.action.followUp.fields&&angular.forEach(scope.action.followUp.fields,function(field,idx){scope.newActivity.fields.push({title:field.title})});var getSection=function(type){switch(type){case"once":return scope.onceActions;case"recurring":return scope.recurringActions;case"legal":return scope.legalActions;default:return void console.error("this shouldn't happen!")}};scope.isModal=function(){switch(scope.action.cta.type){case"initialContent":return!0;case"modal":return!0;default:return!1}},scope.openModal=function(){var modalInstance=$modal.open({templateUrl:"modules/actions/partials/modals/"+scope.action.cta.template,controller:scope.action.cta.controller,backdrop:"static",resolve:{newActivity:function(){return scope.newActivity}}});modalInstance.result.then(function(result){scope.newActivity=result.newActivity,scope.action.hasFollowUp?scope.triggerFollowUp(!0):result.modalError||scope.createActivity(!0,!1)},function(){})},scope.triggerFollowUp=function(hasDoneAction,url,type){hasDoneAction&&(scope.newActivity.startDate=scope.action.startDate=new Date),scope.action.$followUp({type:"add"}),url&&"tel"===type?window.location.href=url:url&&"link"===type&&window.open(url,"_blank")},scope.cancelFollowUp=function(){scope.action.$followUp({type:"remove"})},scope.closeAlert=function(){scope.action.closeAlert=!0;var section=getSection(scope.action.type);section.splice(scope.$index,1)};scope.createActivity=function(isValid,addDOA){if(scope.action.hasFollowUp&&(scope.followUpSubmitted=!0),isValid){addDOA&&scope.newActivity.fields.unshift({title:"This occurred on:",value:$filter("date")(scope.newActivity.startDate,"longDate")}),$rootScope.loading=!0,console.log("create activity pre creation",scope.newActivity);var activity=new Activity(scope.newActivity);console.log("create activity post creation",activity),activity.$save(function(response){console.log("create activity post save",response),Authentication.user=response,$rootScope.loading=!1,scope.action.completed=!0,scope.action.closeAlert=!1,console.log("key",scope.newActivity.key);var newActions=Actions.query({key:scope.newActivity.key},function(){console.log("new actions",newActions),newActions.forEach(function(action){var section=getSection(action.type);section.push(action)})})},function(errorResponse){$rootScope.loading=!1,scope.error=errorResponse.data.message,scope.closeErrorAlert=!1})}}}}}]),angular.module("actions").factory("Actions",["$resource",function($resource){return $resource("api/actions",{},{followUp:{method:"POST"}})}]),angular.module("actions").factory("Messages",["$http","$q","$filter","$location","Authentication",function($http,$q,$filter,$location,Authentication){var user=Authentication.user,getShareMessage=function(type){var message;switch(type){case"share":message="Hello, this is "+user.fullName+" at "+user.address+", Apt. "+user.unit+". I'm experiencing issues with my apartment and would like to get them resolved. A link to my Case History can be found at http://"+$location.host()+"/share/"+user.sharing.key+". Thank you!";break;default:message="Hello, this is "+user.fullName+" at "+user.address+", Apt. "+user.unit+". I'm experiencing issues with my apartment and would like to get them resolved. Please contact me as soon as possible at this phone number. Thank you!"}return message},getRentalHistoryMessage=function(){var message="Hello,\n\nI, "+user.fullName+", am currently residing at "+user.address+", Apt. "+user.unit+" in "+user.borough+", NY  and would like to request the rental history for this apartment. Any information you can provide me would be greatly appreciated.\n\nThank you, \n\n"+user.fullName;return message},getLandlordEmailMessage=function(){for(var message="To whom it may regard, \n\nI am requesting the following repairs in my apartment referenced below [and/or] in the public areas of the building:\n\n",problemsContent="",i=0;i<user.problems.length;i++){var prob=user.problems[i];problemsContent+=prob.title+":\n";for(var j=0;j<prob.issues.length;j++)problemsContent+=" - "+prob.issues[j].key,prob.issues[j].emergency&&(problemsContent+=" (FIX IMMEDIATELY)"),problemsContent+="\n";problemsContent+="\n"}message+=problemsContent+"\n\n";var superContactIdx=user.activity.map(function(i){return i.key}).indexOf("contactSuper");return-1!==superContactIdx&&(message+="I have already contacted the person responsible for making repairs on ",message+=$filter("date")(user.activity[superContactIdx].createdDate,"longDate"),message+=", but the issue has not been resolved. "),message+="In the meantime, I have recorded photo and written evidence of the violations. Please contact me as soon as possible to arrange a time to have these repairs made by replying directly to this email or calling the phone number provided below.",message+="\n\n\nRegards,\n"+user.fullName+"\n"+user.address+"\nApt. "+user.unit+"\n"+user.borough+", NY \n"+$filter("tel")(user.phone)},getLandlordEmailSubject=function(){return"Formal notice of repairs needed at "+user.address+" Unit "+user.unit};return{getShareMessage:getShareMessage,getRentalHistoryMessage:getRentalHistoryMessage,getLandlordEmailMessage:getLandlordEmailMessage,getLandlordEmailSubject:getLandlordEmailSubject}}]),angular.module("actions").factory("Pdf",["$http","$q","Authentication","$filter",function($http,$q,Authentication,$filter){var user=Authentication.user,assemble=function(landlordName,landlordAddr){var zip,assembledObject={issues:[],emergency:!1};zip=user.geo?user.geo.zip:"",assembledObject.tenantInfo={phone:user.phone,name:user.fullName,address:user.address+" "+user.unit+" <br> "+user.borough+" <br> New York, "+zip},assembledObject.landlordInfo={name:landlordName.length?"Dear "+landlordName:"To whom it may concern",address:landlordAddr.length?landlordAddr:""};for(var i=0;i<user.problems.length;i++){var problemPush=angular.copy(user.problems[i]);problemPush.issues.map(function(curr,idx,arr){curr.emergency===!0&&(assembledObject.emergency=!0)}),assembledObject.issues.push(problemPush)}return assembledObject},createComplaint=function(landlord,accessDates){var deferred=$q.defer(),assembledObject=assemble(landlord.name,landlord.address);return assembledObject.accessDates=accessDates,$http({method:"POST",url:"http://pdf-microservice.herokuapp.com/complaint-letter",data:assembledObject}).then(function(response){Authentication.user.complaintUrl=response.data,deferred.resolve(response.data)},function(error){deferred.reject(error)}),deferred.promise};return{createComplaint:createComplaint}}]),angular.module("activity").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$stateProvider.state("listActivity",{url:"/your-case",templateUrl:"modules/activity/views/list-activity.client.view.html",data:{"protected":!0}}).state("showPublic",{url:"/share/:key",templateUrl:"modules/activity/views/list-activity-public.client.view.html",data:{disableBack:!0}})}]),angular.module("activity").controller("ActivityPublicController",["$scope","$stateParams","$state","$http","$filter","Activity","Lightbox",function($scope,$stateParams,$state,$http,$filter,Activity,Lightbox){var query=$stateParams;query.key||$state.go("/"),$scope.list=function(){Activity["public"]({key:query.key},function(user){$scope.user=user,$scope.activities=$scope.user.activity})},$scope.activityTemplate=function(key){return $filter("activityTemplate")(key)},$scope.compareDates=function(start,created){var startDate=new Date(start).setHours(0,0,0,0),createdDate=new Date(created).setHours(0,0,0,0);return startDate!==createdDate},$scope.openLightboxModal=function(photos,index){Lightbox.openModal(photos,index)}}]),angular.module("activity").controller("ActivityController",["$scope","$location","$http","$filter","deviceDetector","Authentication","Users","Activity","Lightbox",function($scope,$location,$http,$filter,deviceDetector,Authentication,Users,Activity,Lightbox){$scope.authentication=Authentication,$scope.location=$location.host(),$scope.shareCollapsed=!1,$scope.isDesktop=deviceDetector.isDesktop(),$scope.list=function(){$scope.activities=Activity.query()},$scope.activityTemplate=function(key){return $filter("activityTemplate")(key)},$scope.openLightboxModal=function(photos,index){Lightbox.openModal(photos,index)}}]),angular.module("activity").filter("activityTemplate",function(){return function(input){var template="/modules/activity/partials/";switch(input){case"sendLetter":template+="complaint-letter.client.view.html";break;case"checklist":template+="checklist.client.view.html";break;default:template+="default-activity.client.view.html"}return template}}),angular.module("activity").factory("Activity",["$resource",function($resource){var objectToFormData=function(obj,form,namespace){var formKey,fd=form||new FormData;for(var property in obj)obj.hasOwnProperty(property)&&(formKey=namespace?namespace+"["+property+"]":property,"object"!=typeof obj[property]||obj[property]instanceof File||obj[property]instanceof Date?fd.append(formKey,obj[property]):objectToFormData(obj[property],fd,formKey));return fd},formDataTransform=function(data,headersGetter){return objectToFormData(data)};return $resource("api/activity",{},{save:{method:"POST",transformRequest:formDataTransform,headers:{"Content-Type":void 0}},"public":{method:"GET",url:"api/activity/public"}})}]),angular.module("admin").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$stateProvider.state("admin",{url:"/admin",templateUrl:"modules/admin/views/admin.client.view.html",data:{"protected":!0}})}]),angular.module("admin").controller("AdminController",["$scope","$q","$modal","Referrals",function($scope,$q,$modal,Referrals){$scope.list=function(){$scope.referrals=Referrals.query()},$scope.newReferral={},$scope.showCodes=function(codes){$modal.open({templateUrl:"modules/admin/partials/show-codes.client.view.html",controller:["$scope","$modalInstance","codes",function($scope,$modalInstance,codes){$scope.codes=codes,$scope.close=function(result){$modalInstance.close()}}],resolve:{codes:function(){return codes}}})},$scope.create=function(){var newReferral=new Referrals($scope.newReferral);newReferral.$save(function(success){$scope.createError=!1,$scope.message="Success!",$scope.list()},function(error){$scope.createError=!0,$scope.message=error.data.message})},$scope["delete"]=function(referral){referral.$delete({id:referral._id}).then(function(){$scope.list()})}}]),angular.module("admin").factory("Referrals",["$resource",function($resource){return $resource("api/referrals",{},{update:{method:"PUT"},validate:{method:"GET",url:"/api/referrals/validate"}})}]),angular.module("core").run(["$rootScope","$state","$window","Authentication",function($rootScope,$state,$window,Authentication){$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){toState.globalStyles?$rootScope.globalStyles=toState.globalStyles:$rootScope.globalStyles="",Authentication.user&&"landing"===toState.name&&(event.preventDefault(),$rootScope.globalStyles="",$state.go("home")),!Authentication.user&&toState.data&&toState.data["protected"]&&(event.preventDefault(),$state.go("signin"))}),$rootScope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){$window.scrollTo(0,0)})}]),angular.module("core").config(["$stateProvider","$urlRouterProvider","$provide",function($stateProvider,$urlRouterProvider,$provide){$provide.decorator("accordionGroupDirective",["$delegate",function($delegate){return $delegate[0].templateUrl="bootstrap-templates/accordion/accordion-group.html",$delegate}]),$provide.decorator("accordionDirective",["$delegate",function($delegate){return $delegate[0].templateUrl="bootstrap-templates/accordion/accordion.html",$delegate}]),$urlRouterProvider.otherwise("/not-found"),$stateProvider.state("landing",{url:"/",templateUrl:"modules/core/views/landing.client.view.html",data:{disableBack:!0},globalStyles:"landing white-bg"}).state("not-found",{url:"/not-found",templateUrl:"modules/core/views/404.client.view.html",data:{disableBack:!0}}).state("manifesto",{url:"/manifesto",templateUrl:"modules/core/views/manifesto.client.view.html",data:{disableBack:!0}}).state("home",{url:"/home",templateUrl:"modules/core/views/home.client.view.html",data:{"protected":!0,disableBack:!0}}).state("contact",{url:"/contact",templateUrl:"modules/core/views/contact.client.view.html",data:{},globalStyles:"white-bg"})}]),angular.module("core").controller("FooterController",["$scope","$window","Authentication",function($scope,$window,Authentication){var links={actions:{link:"listActions",title:"Take Action",icon:"/modules/core/img/sections/action.svg"},activity:{link:"listActivity",title:"Case History",icon:"/modules/core/img/sections/history.svg"},issues:{link:"updateProblems",title:"Issue Checklist",icon:"/modules/core/img/sections/issues.svg"},profile:{link:"settings.profile",title:"Profile",icon:"/modules/core/img/sections/profile.svg"},help:{link:"findHelp",title:"Find Help",icon:"/modules/core/img/sections/help.svg"},kyr:{link:"kyr",title:"Know Your Rights",icon:"/modules/core/img/sections/kyr.svg"}};$scope.footerLinks=[],$scope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){switch(toState.name){case"kyr":$scope.footerLinks=[links.actions,links.help];break;case"kyrDetail":$scope.footerLinks=[links.actions,links.help];break;case"findHelp":case"listActions":$scope.footerLinks=[links.activity,links.kyr];break;case"listActivity":$scope.footerLinks=[links.issues,links.help];break;case"updateProblems":$scope.footerLinks=[links.actions,links.activity];break;default:$scope.footerLinks=[]}})}]),angular.module("core").controller("HeaderController",["$rootScope","$state","$scope","$window","Authentication",function($rootScope,$state,$scope,$window,Authentication){$scope.authentication=Authentication,$scope.window=$window,$rootScope.$on("$stateChangeSucess",function(event,toState,toParams,fromState,fromParams){$rootScope.showBack=!0,toState.data&&toState.data.disableBack&&($rootScope.showBack=!1)})}]),angular.module("core").controller("HomeController",["$rootScope","$scope","Authentication","deviceDetector",function($rootScope,$scope,Authentication,deviceDetector){$scope.authentication=Authentication,$scope.device=deviceDetector,$rootScope.closeDashboardAlert=!1}]),angular.module("core").controller("LandingController",["$scope","Authentication","deviceDetector",function($scope,Authentication,deviceDetector){$scope.authentication=Authentication,$scope.device=deviceDetector}]),angular.module("core").directive("bottomOnClick",["$document","$timeout",function($document,$timeout){return{controller:["$parse","$element","$attrs","$scope",function($parse,$element,$attrs,$scope){var parent=$attrs.bottomOnClick,parentElm=document.getElementById(parent);$element.bind("click",function(e){$timeout(function(){parentElm.scrollTop=parentElm.scrollHeight},0)})}]}}]),angular.module("core").directive("emailMessage",["deviceDetector","Authentication","Messages",function(deviceDetector,Authentication,Messages){return{restrict:"A",scope:!1,link:function(scope,element,attrs){var msg=Messages.getShareMessage("share"),href="mailto:"+encodeURI(Authentication.user.referral.email+"?subject="+Authentication.user.fullName+" - JustFix.nyc Case History&body="+msg);attrs.$set("href",href)}}}]),angular.module("core").directive("filesModel",function(){return{controller:["$parse","$element","$attrs","$scope",function($parse,$element,$attrs,$scope){var exp=$parse($attrs.filesModel);$element.on("change",function(){exp.assign($scope,this.files),$scope.$apply()})}]}}),angular.module("core").directive("focusOnTouch",function(){return{restrict:"A",link:function(scope,element,attr){element.on("touchstart",function(e){element.focus(),e.preventDefault(),e.stopPropagation()})}}}).directive("stopEvent",function(){return{restrict:"A",link:function(scope,element,attr){element.on(attr.stopEvent,function(e){e.stopPropagation()})}}}),angular.module("core").directive("fullBg",["$window",function($window){return function(scope,element,attrs){function getWidth(){return self.innerHeight?self.innerWidth:document.documentElement&&document.documentElement.clientHeight?document.documentElement.clientWidth:document.body?document.body.clientWidth:void 0}$window.addEventListener("resize",function(){element.css("width",getWidth()+"px")}),element.css("width",getWidth()+"px")}}]),angular.module("core").directive("goToTop",["$document",function($document){return{restrict:"A",link:function(scope,elm,attrs){elm.bind("click",function(){function scrollToTop(element,to,duration){if(!(0>duration)){var difference=to-element.scrollTop,perTick=difference/duration*10;setTimeout(function(){element.scrollTop=element.scrollTop+perTick,scrollToTop(element,to,duration-10)},10)}}scrollToTop($document[0].body,0,200)})}}}]),angular.module("core").directive("inheritHeight",["$window","$timeout","deviceDetector",function($window,$timeout,deviceDetector){return{restrict:"A",link:function(scope,elm,attrs){scope.$watch("status.loading",function(newV,oldV){$timeout(function(){elm.css("height",elm[0].querySelector(".letter-step.ng-enter").offsetHeight+"px")})})}}}]),angular.module("core").directive("jumpTo",["$document",function($document){return{controller:["$parse","$element","$attrs","$scope",function($parse,$element,$attrs,$scope){var id=$attrs.jumpTo,duration=1e3,easing=function(t){return.5>t?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},offset=0,someElement=angular.element(document.getElementById(id));$element.bind("click",function(e){$document.scrollToElement(someElement,offset,duration,easing)})}]}}]),angular.module("core").directive("languageSelect",["LocaleService",function(LocaleService){return{restrict:"A",replace:!0,templateUrl:"modules/core/partials/language-select.client.view.html",controller:["$scope",function($scope){$scope.currentLocaleDisplayName=LocaleService.getLocaleDisplayName(),$scope.localesDisplayNames=LocaleService.getLocalesDisplayNames(),$scope.visible=$scope.localesDisplayNames&&$scope.localesDisplayNames.length>1,$scope.changeLanguage=function(locale){LocaleService.setLocaleByDisplayName(locale)}}]}}]),angular.module("core").directive("loading",["$document",function($document){return{restrict:"E",templateUrl:"modules/core/partials/loading.client.view.html",link:function(scope,elm,attrs){}}}]),angular.module("core").directive("mobileDatePlaceholder",["deviceDetector",function(deviceDetector){return{restrict:"A",scope:!1,link:function(scope,elm,attrs){(deviceDetector.isMobile()||deviceDetector.isTablet())&&elm.addClass("date-mobile"),scope.$watch(attrs.ngModel,function(v){v&&elm.removeClass("date-mobile")})}}}]),angular.module("core").directive("phoneInput",["$filter","$browser",function($filter,$browser){return{require:"ngModel",link:function($scope,$element,$attrs,ngModelCtrl){var listener=function(){var value=$element.val().replace(/[^0-9]/g,"");$element.val($filter("tel")(value,!1)),value.length<10||value.search(/[^a-z]/g)?ngModelCtrl.$setValidity("",!1):ngModelCtrl.$setValidity("",!0)};ngModelCtrl.$parsers.push(function(viewValue){return viewValue.replace(/[^0-9]/g,"").slice(0,10)}),ngModelCtrl.$render=function(){$element.val($filter("tel")(ngModelCtrl.$viewValue,!1))};var unbindAfterInit=$scope.$watch(function(){return ngModelCtrl.$modelValue},function(value){$element.val($filter("tel")(ngModelCtrl.$viewValue,!1)),unbindAfterInit()});$element.bind("change",listener),$element.bind("keydown",function(event){var key=event.keyCode;91===key||key>15&&19>key||key>=37&&40>=key||$browser.defer(listener)}),$element.bind("paste cut",function(){$browser.defer(listener)})}}}]),angular.module("core").directive("printButton",["deviceDetector","$window",function(deviceDetector,$window){return{restrict:"A",scope:!1,link:function(scope,element,attrs){deviceDetector.isDesktop()?element.addClass("print-button"):element.css("display","none"),
element.on("click",function(event){$window.print()})}}}]),angular.module("core").directive("propagateEvent",function(){return{restrict:"A",link:function(scope,element,attr){element.on("click",function(e){console.log("propagate event")})}}}),angular.module("core").directive("smsMessage",["deviceDetector","Authentication","Messages",function(deviceDetector,Authentication,Messages){return{restrict:"A",scope:!1,link:function(scope,element,attrs){var isIOS8=function(){var deviceAgent=deviceDetector.raw.userAgent.toLowerCase();return/(iphone|ipod|ipad).* os [8-9]_/.test(deviceAgent)};element.on("click",function(e){var href="sms:",type=attrs.type,msg=Messages.getShareMessage(type);attrs.phone&&attrs.phone.length&&(href+=attrs.phone),"ios"===deviceDetector.os?(href+=isIOS8()?"&":";",href=href+"body="+msg,console.log("href",href),attrs.$set("href",href)):"android"===deviceDetector.os?(href=href+"?body="+msg,attrs.$set("href",href)):(href=href+"?body="+msg,console.log(href),console.log("If you were using a phone, the message would be: \n\n"+msg))})}}}]),angular.module("core").directive("stopEvent",function(){return{restrict:"A",link:function(scope,element,attr){element.on(attr.stopEvent,function(e){e.stopPropagation()})}}}),angular.module("core").directive("twitterFollow",["$timeout",function($timeout){return{link:function(scope,element,attr){$timeout(function(){twttr.widgets.createFollowButton("JustFixNYC",element[0],{showScreenName:!1,showCount:!1})})}}}]),angular.module("core").directive("variableHeight",["$document","$timeout",function($document,$timeout){return{controller:["$parse","$element","$attrs","$scope",function($parse,$element,$attrs,$scope){var parent=$attrs.variableHeight,parentElm=document.getElementById(parent);$scope.$watch(function(){angular.element(parentElm).css("height",$element[0].offsetHeight+"px")})}]}}]),angular.module("core").directive("windowHeight",["$window","deviceDetector",function($window,deviceDetector){return function(scope,element,attrs){function getHeight(){return self.innerWidth?self.innerHeight:document.documentElement&&document.documentElement.clientWidth?document.documentElement.clientHeight:document.body?document.body.clientHeight:void 0}deviceDetector.isMobile()||$window.addEventListener("resize",function(){element.css("height",getHeight()+"px")}),deviceDetector.isMobile()&&"safari"===deviceDetector.browser?element.css("height",getHeight()+60+"px"):element.css("height",getHeight()+"px")}}]),angular.module("core").filter("firstname",function(){return function(input){return input.split(" ")[0]}}),angular.module("core").filter("tel",function(){return function(tel){if(!tel)return"";var value=tel.toString().trim().replace(/^\+/,"");if(value.match(/[^0-9]/))return tel;var city,number;switch(value.length){case 1:case 2:case 3:city=value;break;default:city=value.slice(0,3),number=value.slice(3)}return number?(number=number.length>3?number.slice(0,3)+"-"+number.slice(3,7):number,("("+city+") "+number).trim()):"("+city}}),angular.module("core").filter("titlecase",function(){return function(input){var smallWords=/^(a|an|and|as|at|but|by|en|for|if|in|nor|of|on|or|per|the|to|vs?\.?|via)$/i;return input=input.toLowerCase(),input.replace(/[A-Za-z0-9\u00C0-\u00FF]+[^\s-]*/g,function(match,index,title){return index>0&&index+match.length!==title.length&&match.search(smallWords)>-1&&":"!==title.charAt(index-2)&&("-"!==title.charAt(index+match.length)||"-"===title.charAt(index-1))&&title.charAt(index-1).search(/[^\s-]/)<0?match.toLowerCase():match.substr(1).search(/[A-Z]|\../)>-1?match:match.charAt(0).toUpperCase()+match.substr(1)})}}),angular.module("core").service("LocaleService",["$translate","LOCALES","$rootScope","tmhDynamicLocale",function($translate,LOCALES,$rootScope,tmhDynamicLocale){var localesObj=LOCALES.locales,_LOCALES=Object.keys(localesObj);_LOCALES&&0!==_LOCALES.length||console.error("There are no _LOCALES provided");var _LOCALES_DISPLAY_NAMES=[];_LOCALES.forEach(function(locale){_LOCALES_DISPLAY_NAMES.push(localesObj[locale])});var currentLocale=$translate.proposedLanguage(),checkLocaleIsValid=function(locale){return-1!==_LOCALES.indexOf(locale)},setLocale=function(locale){return checkLocaleIsValid(locale)?(currentLocale=locale,void $translate.use(locale)):void console.error('Locale name "'+locale+'" is invalid')};return $rootScope.$on("$translateChangeSuccess",function(event,data){document.documentElement.setAttribute("lang",data.language),tmhDynamicLocale.set(data.language.toLowerCase().replace(/_/g,"-"))}),{getLocaleDisplayName:function(){return localesObj[currentLocale]},setLocaleByDisplayName:function(localeDisplayName){setLocale(_LOCALES[_LOCALES_DISPLAY_NAMES.indexOf(localeDisplayName)])},getLocalesDisplayNames:function(){return _LOCALES_DISPLAY_NAMES}}}]),angular.module("core").service("Menus",[function(){this.defaultRoles=["*"],this.menus={};var shouldRender=function(user){if(!user)return this.isPublic;if(~this.roles.indexOf("*"))return!0;for(var userRoleIndex in user.roles)for(var roleIndex in this.roles)if(this.roles[roleIndex]===user.roles[userRoleIndex])return!0;return!1};this.validateMenuExistance=function(menuId){if(menuId&&menuId.length){if(this.menus[menuId])return!0;throw new Error("Menu does not exists")}throw new Error("MenuId was not provided")},this.getMenu=function(menuId){return this.validateMenuExistance(menuId),this.menus[menuId]},this.addMenu=function(menuId,isPublic,roles){return this.menus[menuId]={isPublic:isPublic||!1,roles:roles||this.defaultRoles,items:[],shouldRender:shouldRender},this.menus[menuId]},this.removeMenu=function(menuId){this.validateMenuExistance(menuId),delete this.menus[menuId]},this.addMenuItem=function(menuId,menuItemTitle,menuItemURL,menuItemType,menuItemUIRoute,isPublic,roles,position){return this.validateMenuExistance(menuId),this.menus[menuId].items.push({title:menuItemTitle,link:menuItemURL,menuItemType:menuItemType||"item",menuItemClass:menuItemType,uiRoute:menuItemUIRoute||"/"+menuItemURL,isPublic:null===isPublic||"undefined"==typeof isPublic?this.menus[menuId].isPublic:isPublic,roles:null===roles||"undefined"==typeof roles?this.menus[menuId].roles:roles,position:position||0,items:[],shouldRender:shouldRender}),this.menus[menuId]},this.addSubMenuItem=function(menuId,rootMenuItemURL,menuItemTitle,menuItemURL,menuItemUIRoute,isPublic,roles,position){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)this.menus[menuId].items[itemIndex].link===rootMenuItemURL&&this.menus[menuId].items[itemIndex].items.push({title:menuItemTitle,link:menuItemURL,uiRoute:menuItemUIRoute||"/"+menuItemURL,isPublic:null===isPublic||"undefined"==typeof isPublic?this.menus[menuId].items[itemIndex].isPublic:isPublic,roles:null===roles||"undefined"==typeof roles?this.menus[menuId].items[itemIndex].roles:roles,position:position||0,shouldRender:shouldRender});return this.menus[menuId]},this.removeMenuItem=function(menuId,menuItemURL){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)this.menus[menuId].items[itemIndex].link===menuItemURL&&this.menus[menuId].items.splice(itemIndex,1);return this.menus[menuId]},this.removeSubMenuItem=function(menuId,submenuItemURL){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)for(var subitemIndex in this.menus[menuId].items[itemIndex].items)this.menus[menuId].items[itemIndex].items[subitemIndex].link===submenuItemURL&&this.menus[menuId].items[itemIndex].items.splice(subitemIndex,1);return this.menus[menuId]},this.addMenu("topbar")}]),angular.module("findhelp").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$stateProvider.state("findHelp",{url:"/find-help",templateUrl:"modules/findhelp/views/find-help.client.view.html",data:{"protected":!0}})}]),angular.module("findhelp").controller("FindHelpController",["$scope","$window","Authentication","CartoDB","Hotlines",function($scope,$window,Authentication,CartoDB,Hotlines){$scope.user=Authentication.user,$scope.hotlines=[],$scope.update=function(type){var lat=$scope.user.geo.lat,lng=$scope.user.geo.lon;$scope.updateCartoMap(lat,lng,type),"hotlines"!=type||$scope.hotlines.length?"hotlines"==type&&$scope.hotlines.length?$scope.resources=$scope.hotlines:$scope.updateCartoList(lat,lng,type):Hotlines.getLocalFile().then(function(data){$scope.resources=$scope.hotlines=data},function(err){console.log("errors:"+errors)})},$scope.init=function(){$scope.update("community")},$scope.updateCartoList=function(lat,lng,orgType){CartoDB.queryByLatLng(lat,lng,orgType).done(function(data){0==data.rows.length,$scope.resources=data.rows,$scope.$apply()}).error(function(errors){console.log("errors:"+errors)})}}]),angular.module("findhelp").directive("cartoMap",["$rootScope","CartoDB",function($rootScope,CartoDB){return{restrict:"E",template:'<div id="map" class="panel"></div>',scope:!1,link:function(scope,element,attrs){var map=L.map("map",{scrollWheelZoom:!1,center:[40.7127,-73.96270751953125],zoom:10});L.Icon.Default.imagePath="/modules/core/img/leaflet";L.mapboxGL({accessToken:"pk.eyJ1IjoiZGFuLWthc3MiLCJhIjoiY2lsZTFxemtxMGVpdnVoa3BqcjI3d3Q1cCJ9.IESJdCy8fmykXbb626NVEw",style:"mapbox://styles/dan-kass/cilljc5nu004d9vkngyozkhzb",attributionControl:!0}).addTo(map);map.attributionControl.removeFrom(map),map.attributionControl.setPrefix("");var credits=L.control.attribution().addTo(map);credits.addAttribution("© <a href='https://www.mapbox.com/map-feedback/'>Mapbox</a> © <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a>");var mainSublayer,userMarker,layerSource={user_name:"dan-kass",type:"cartodb",sublayers:[{sql:"SELECT * FROM nyc_cbos_locations",cartocss:"#nyc_cbos_locations{marker-fill-opacity:.9;marker-line-color:#FFF;marker-line-width:1;marker-line-opacity:1;marker-placement:point;marker-type:ellipse;marker-width:10;marker-fill:#F60;marker-allow-overlap:true}"}]};cartodb.createLayer(map,layerSource).addTo(map).done(function(layer){mainSublayer=layer.getSubLayer(0),scope.init()}).error(function(err){console.log("An error occurred: "+err)}),scope.updateCartoMap=function(lat,lng,type){var query,cartocss;"legal"==type||"community"==type?(query="SELECT *, row_number() OVER (ORDER BY dist) as rownum FROM ( SELECT loc.cartodb_id, loc.the_geom, loc.the_geom_webmercator, round( (ST_Distance( ST_GeomFromText('Point("+lng+" "+lat+")', 4326)::geography, loc.the_geom::geography ) / 1609)::numeric, 1 ) AS dist FROM nyc_cbos_locations AS loc, nyc_cbos_service_areas AS sa WHERE ST_Intersects( ST_GeomFromText( 'Point("+lng+" "+lat+")', 4326 ), sa.the_geom ) AND loc.organization = sa.organization AND loc.org_type IN ('"+type+"') ORDER BY dist ASC ) T LIMIT 5",cartocss="#nyc_cbos_locations{marker-fill-opacity:.9;marker-line-color:#FFF;marker-line-width:1;marker-line-opacity:1;marker-placement:point;marker-type:ellipse;marker-width:10;marker-fill:#F60;marker-allow-overlap:true}#nyc_cbos_locations::labels{text-name:[rownum];text-face-name:'DejaVu Sans Book';text-size:20;text-label-position-tolerance:10;text-fill:#000;text-halo-fill:#FFF;text-halo-radius:2;text-dy:-10;text-allow-overlap:true;text-placement:point;text-placement-type:simple}"):(query="SELECT * FROM nyc_cbos_locations",cartocss="#nyc_cbos_locations{marker-fill-opacity:.9;marker-line-color:#FFF;marker-line-width:1;marker-line-opacity:1;marker-placement:point;marker-type:ellipse;marker-width:10;marker-fill:#F60;marker-allow-overlap:true}"),userMarker&&map.removeLayer(userMarker),userMarker=L.marker([lat,lng]),userMarker.addTo(map),mainSublayer.set({sql:query,cartocss:cartocss}),CartoDB.getSQL().getBounds(query).done(function(bounds){bounds.push([lat,lng]),map.fitBounds(bounds,{padding:[10,10]})})}}}}]),angular.module("findhelp").service("CartoDB",[function(){var cartoSQL=new cartodb.SQL({user:"dan-kass"});return{queryByLatLng:function(lat,lng,type){var query="SELECT *, row_number() OVER (ORDER BY dist) as rownum FROM ( SELECT loc.organization, loc.contact_information, loc.address, loc.services, round( (ST_Distance( ST_GeomFromText('Point("+lng+" "+lat+")', 4326)::geography, loc.the_geom::geography ) / 1609)::numeric, 1 ) AS dist FROM nyc_cbos_locations AS loc, nyc_cbos_service_areas AS sa WHERE ST_Intersects( ST_GeomFromText( 'Point("+lng+" "+lat+")', 4326 ), sa.the_geom ) AND loc.organization = sa.organization AND loc.org_type IN ('"+type+"') ORDER BY dist ASC ) T LIMIT 5";return cartoSQL.execute(query)},getSQL:function(){return cartoSQL}}}]),angular.module("onboarding").factory("Hotlines",["$http","$q",function($http,$q){var requestLocalFile=function(){var deferred=$q.defer();return $http.get("data/hotlines.json").then(function(response){deferred.resolve(response.data)},function(err){deferred.reject(err)}),deferred.promise};return{getLocalFile:function(){return requestLocalFile()}}}]),angular.module("issues").run(["Menus",function(Menus){}]),angular.module("issues").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.when("/issues/create","/issues/create/checklist"),$stateProvider.state("listIssues",{url:"/issues",templateUrl:"modules/issues/views/list-issues.client.view.html"}).state("createIssue",{url:"/issues/create",templateUrl:"modules/issues/views/create-issue.client.view.html","abstract":!0}).state("createIssue.accessCode",{url:"/access-code",templateUrl:"modules/issues/partials/access-code.client.view.html",data:{disableBack:!0}}).state("createIssue.checklist",{url:"/checklist",title:"Issues Checklist",templateUrl:"modules/issues/partials/create-issue-checklist.client.view.html"}).state("createIssue.general",{url:"/general",title:"General Info",templateUrl:"modules/issues/partials/create-issue-general.client.view.html"}).state("createIssue.personal",{url:"/personal",title:"Personal Information",templateUrl:"modules/issues/partials/create-issue-personal.client.view.html"}).state("createIssue.contact",{url:"/contact",title:"Who To Contact",templateUrl:"modules/issues/partials/create-issue-contact.client.view.html"}).state("createIssue.review",{url:"/review",title:"Review",templateUrl:"modules/issues/partials/create-issue-review.client.view.html"}).state("updateIssues",{url:"/issues/update",templateUrl:"modules/issues/views/update-issues.client.view.html"})}]),angular.module("issues").controller("IssuesChecklistController",["$scope","Issues",function($scope,Issues){$scope.checklist={},$scope.open=[],void 0===$scope.updateView&&($scope.updateView=!1),Issues.getChecklist().then(function(data){var i=0;for(var area in data[0]){var issues=data[0][area].issues;$scope.checklist[area]={numChecked:$scope.newIssue.issues[area]?$scope.newIssue.issues[area].length:0,issues:issues},$scope.newIssue.issues[area]||($scope.newIssue.issues[area]=[]),issues.forEach(function(issue){$scope.issues[area]&&-1!==$scope.issues[area].map(function(i){return i.title}).indexOf(issue.title)&&$scope.select(area,issue)}),$scope.open[i++]=!1}},function(err){console.error(err)}),$scope.oneAtATime=!0,$scope.status={idx:-1,isFirstOpen:!0,isFirstDisabled:!1},$scope.select=function(area,issue){if(this.isSelected(area,issue)){var i=$scope.newIssue.issues[area].indexOf(issue);$scope.newIssue.issues[area].splice(i,1),$scope.checklist[area].numChecked--}else $scope.newIssue.issues[area].push(issue),$scope.checklist[area].numChecked++},$scope.isSelected=function(area,issue){return $scope.newIssue.issues[area]?-1!==$scope.newIssue.issues[area].indexOf(issue):!1},$scope.closeGroup=function(idx){$scope.open[idx]=!1}}]),angular.module("issues").controller("IssuesController",["$scope","$location","$http","Authentication","Users","Referrals",function($scope,$location,$http,Authentication,Users,Referrals){if($scope.authentication=Authentication,$scope.authentication.user?$scope.issues=$scope.authentication.user.issues:$scope.issues={},$scope.newIssue={},$scope.newIssue.issues={},$location.search().address){var query=$location.search();$scope.newIssue.name=query.name,$scope.newIssue.phone=query.phone,$scope.newIssue.address=query.address,$scope.newIssue.borough=query.borough,$scope.newIssue.unit=query.unit,$scope.newIssue.nycha=query.nycha,$scope.newIssue.password=query.password}$scope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){$scope.currentStateTitle=toState.title}),$scope.newUser={},$scope.newUser.accessCode="test",$scope.validateCode=function(){var referral=new Referrals;referral.$validate({code:$scope.newUser.accessCode},function(success){success.referral?(alert("valid"),console.log(success.referral)):alert("invalid")},function(error){})},$scope.create=function(){var newUser={fullName:$scope.newIssue.name,firstName:"Dan",lastName:"Kass",phone:"0000000000",borough:$scope.newIssue.borough,address:$scope.newIssue.address,unit:$scope.newIssue.unit,nycha:$scope.newIssue.nycha,issues:$scope.newIssue.issues,password:"password"};console.log(newUser),$http.post("/auth/signup",newUser).success(function(response){$scope.authentication.user=response,$location.path("/")}).error(function(response){console.log(response),$scope.error=response})},$scope.update=function(){$scope.authentication.user.issues=$scope.newIssue.issues;var user=new Users($scope.authentication.user);user.$update(function(response){Authentication.user=response,$scope.authentication.user=response,$location.path("/issues")},function(response){$scope.error=response.data.message})},$scope.hasIssues=function(){for(var area in $scope.issues)if($scope.issues[area].length)return!0;return!1}}]),angular.module("issues").factory("Issues",["$http","$q","Authentication",function($http,$q,Authentication){var checklist="data/checklist_old.json",request=function(url){var deferred=$q.defer();return $http.get(url).then(function(response){deferred.resolve(response.data)},function(err){deferred.reject()}),deferred.promise};return{getChecklist:function(){return request(checklist)},getUserIssuesByKey:function(key){return Authentication.user.issues[key]},getUserAreas:function(){var areas=[];return angular.forEach(Authentication.user.issues,function(v,k){v.length&&areas.push(k)}),areas}}}]),angular.module("kyr").run(["$rootScope","$state","$window","$location",function($rootScope,$state,$window,$location){$rootScope.$on("$stateChangeSuccess",function(){$rootScope.noMargin=$state.current.noMargin,$state.current.localHistory?$rootScope.showKyrBackBtn=!0:$rootScope.showKyrBackBtn=!1})}]),function(){function routeConfig($stateProvider,$urlRouterProvider){$stateProvider.state("kyr",{url:"/kyr",templateUrl:"modules/kyr/views/kyr.client.view.html",controller:"KyrController",noMargin:!0}).state("kyrDetail",{url:"/kyr/:kyrId",templateUrl:"modules/kyr/views/kyr-detail.client.view.html",controller:"KyrDetailController",noMargin:!0,data:{disableBack:!0},localHistory:!0,globalStyles:"white-bg"})}angular.module("kyr").config(routeConfig),routeConfig.$inject=["$stateProvider","$urlRouterProvider"]}(),angular.module("kyr").controller("KyrDetailController",["$scope","$stateParams","kyrService","$sce",function($scope,$stateParams,kyrService,$sce){var queryThis=$stateParams.kyrId-1;$scope.expand=!1,$scope.canExpand=!1,kyrService.single(queryThis).then(function(data){return $scope.kyr=data,$scope.content=$sce.trustAsHtml(data.content),data.readMore?$scope.canExpand=!0:void 0})}]),angular.module("kyr").controller("KyrController",["kyrService","$scope","Pdf",function(kyrService,$scope,Pdf){$scope.kyrResponse,kyrService.fetch().then(function(data){$scope.kyrResponse=data},function(err){console.log(err)})}]),angular.module("kyr").filter("newlines",["$sce",function($sce){return function(text){var treatedText=text.replace(/\\n/g,"<br/>");return $sce.trustAsHtml(treatedText)}}]),angular.module("kyr").factory("kyrService",["$resource","$http","$q",function($resource,$http,$q){return this.fetch=function(){var deferred=$q.defer();return $http.get("/data/kyr.json").then(function(data){var finalData=data.data;deferred.resolve(finalData)},function(err){console.log(err),deferred.reject(err)}),deferred.promise},this.single=function(id){var deferred=$q.defer();return $http.get("/data/kyr.json").then(function(data){var finalKyr=data.data[id],length=data.data.length;id===length-1?finalKyr.next=!1:finalKyr.next=id+2,0>=id?finalKyr.prev=!1:finalKyr.prev=id,void 0!==finalKyr?deferred.resolve(finalKyr):deferred.reject("This KYR does not exist")},function(err){deferred.reject(err)}),deferred.promise},this}]),angular.module("onboarding").run(["$rootScope","$state","Authentication","$window",function($rootScope,$state,Authentication,$window){$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){Authentication.user||!toState.onboarding||$rootScope.validated||"onboarding.accessCode"===toState.name||(event.preventDefault(),$state.go("onboarding.accessCode"))})}]),angular.module("onboarding").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.when("/onboarding","/onboarding/referral"),$stateProvider.state("onboarding",{url:"/onboarding",templateUrl:"modules/onboarding/views/onboarding.client.view.html",controller:"OnboardingController","abstract":!0,data:{disableBack:!0}}).state("onboarding.accessCode",{url:"/referral",templateUrl:"modules/onboarding/partials/onboarding-code.client.view.html",onboarding:!0,globalStyles:"white-bg"}).state("onboarding.success",{url:"/success",templateUrl:"modules/onboarding/partials/onboarding-success.client.view.html",onboarding:!0,globalStyles:"white-bg"}).state("onboarding.problems",{url:"/checklist",templateUrl:"modules/onboarding/partials/onboarding-problems.client.view.html",onboarding:!0}).state("onboarding.details",{url:"/personal",templateUrl:"modules/onboarding/partials/onboarding-details.client.view.html",onboarding:!0})}]),angular.module("onboarding").controller("OnboardingController",["$rootScope","$scope","$location","$filter","Authentication","Referrals","$http","$modal",function($rootScope,$scope,$location,$filter,Authentication,Referrals,$http,$modal){$scope.authentication=Authentication,$scope.newUser={},$scope.newUser.problems=[],$scope.newUser.sharing={enabled:!1},$scope.accessCode={valid:!1},"undefined"!=typeof DEBUG&&1==DEBUG&&($scope.newUser={firstName:"Dan",lastName:"Stevenson",password:"password",borough:"Brooklyn",address:"654 Park Place",unit:"1RF",phone:(Math.floor(9999999999*Math.random())+1111111111).toString(),problems:[],sharing:{enabled:!1}},$scope.accessCode={value:"test5",valid:!1}),$scope.validateCode=function(){if($scope.accessCode.valueEntered&&$scope.accessCode.valueEntered===$scope.accessCode.value)$scope.accessCode.valueEntered==$scope.accessCode.value&&($scope.accessCode.valid=!0,$location.path("/onboarding/success"),$scope.codeError=!1,$scope.codeWrong=!1);else{var referral=new Referrals;referral.$validate({code:$scope.accessCode.value},function(success){success.referral?($scope.accessCode.valid=$rootScope.validated=!0,$scope.accessCode.valueEntered=$scope.accessCode.value,$scope.newUser.referral=success.referral,$scope.newUser.referral.code=$scope.accessCode.value,$location.path("/onboarding/success"),$scope.codeError=!1,$scope.codeWrong=!1):($scope.codeError=!1,$scope.codeWrong=!0)},function(error){$scope.codeErrorMessage=error.data.message,$scope.codeError=!0,$scope.codeWrong=!1})}},$scope.cancelAccessCode=function(){$scope.accessCode.valid=!1,$location.path("/onboarding/referral")},$scope.additionalInfo=function(){$modal.open({animation:"true",templateUrl:"modules/onboarding/partials/additional-info.client.view.html"})},$scope.userError=!1,$scope.createAndNext=function(isValid){console.log("create account pre save",$scope.newUser),isValid?($scope.newUser.firstName=$filter("titlecase")($scope.newUser.firstName),$scope.newUser.lastName=$filter("titlecase")($scope.newUser.lastName),$scope.newUser.address=$filter("titlecase")($scope.newUser.address),$scope.userError=!1,$rootScope.loading=!0,$http.post("/api/auth/signup",$scope.newUser).success(function(response){$rootScope.loading=!1,$rootScope.takeActionAlert=!0,$scope.authentication.user=response,console.log("create account post save",response),$location.path("/tutorial")}).error(function(err){$rootScope.loading=!1,console.log(err),$scope.error=err})):$scope.userError=!0}}]),angular.module("onboarding").directive("pwCheck",[function(){return{require:"ngModel",link:function(scope,elem,attrs,ctrl){var firstPassword=attrs.pwCheck;elem.on("keyup",function(){scope.$apply(function(){var v=elem.val()===document.getElementById(firstPassword).value;ctrl.$setValidity("pwmatch",v)})})}}}]),angular.module("onboarding").directive("selectionList",function(){return{templateUrl:"modules/onboarding/partials/selection-list.client.view.html",restrict:"E",link:function(scope,element,attrs){for(var aTags=element.find("a"),wrappedTags=[],activateThis=function(){this.on("click",function(e){for(var thisWrapped=angular.element(this),i=0;i<wrappedTags.length;i++)wrappedTags[i].removeClass("active");thisWrapped.addClass("active"),scope.process=this.getAttribute("process"),console.log(scope)})},i=0;i<aTags.length;i++){var elm=angular.element(aTags[i]);activateThis.call(elm),wrappedTags.push(elm)}}}}),angular.module("onboarding").factory("AccessCodeService",["$resource",function($resource){return $resource("access-code",{},{save:{method:"POST"},get:{method:"GET"},"delete":{method:"DELETE"}})}]),angular.module("onboarding").factory("UserListingService",["$resource",function($resource){return $resource("users/list")}]),angular.module("problems").run(["$rootScope","$state","$window","Authentication","Users","Problems",function($rootScope,$state,$window,Authentication,Users,Problems){}]),angular.module("problems").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$stateProvider.state("updateProblems",{url:"/checklist",templateUrl:"modules/problems/views/update-problems.client.view.html"})}]),angular.module("problems").controller("ModalProblemController",["$scope","Problems","$modalInstance","issues","userProblem",function($scope,problems,$modalInstance,issues,userProblem){$scope.issues=issues,$scope.userProblem=userProblem;var userIssuesClone=$scope.userProblem.issues.slice(0);$scope.isSelected=function(issue){return $scope.userProblem.issues.containsByKey(issue.key)},$scope.select=function(issue){$scope.isSelected(issue)?$scope.userProblem.issues.removeByKey(issue.key):$scope.userProblem.issues.push(issue)},$scope.save=function(event){$scope.newOther&&$scope.newOther.key.length&&$scope.addOther(event),$modalInstance.close()},$scope.cancel=function(){$scope.userProblem.issues=userIssuesClone,$modalInstance.dismiss()}}]),angular.module("problems").controller("ProblemsController",["$rootScope","$scope","$state","Authentication","Users","Problems",function($rootScope,$scope,$state,Authentication,Users,Problems){$scope.user=Authentication.user,$scope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams,options){if($scope.hasChangedProblems&&!toState.updated){event.preventDefault(),toState.updated=!0,$rootScope.loading=!0;var user=new Users(Authentication.user);user.$updateChecklist(function(response){$rootScope.loading=!1,$rootScope.dashboardSuccess=!0,Authentication.user=response,$state.go(toState)},function(response){$rootScope.loading=!1,$rootScope.dashboardError=!0,$state.go(toState)})}else toState.updated&&(toState.updated=!1)})}]),angular.module("onboarding").directive("problemsChecklist",["Authentication","Problems","$modal",function(Authentication,Problems,$modal){return{templateUrl:"/modules/problems/partials/problems-list.client.view.html",restrict:"E",scope:!1,link:function(scope,element,attrs){var newProblem=function(problem){var newProb={};return newProb.key=problem.key,newProb.title=problem.title,newProb.icon=problem.icon,newProb.issues=[],newProb.photos=[],newProb};Authentication.user?scope.ourUser=Authentication.user:scope.ourUser=scope.newUser,Problems.getLocalFile().then(function(data){scope.problems=data,scope.ourUser.problems.forEach(function(userProb){var prob=scope.problems.getByKey(userProb.key);prob.numChecked=userProb.issues.length,userProb.issues.forEach(function(i){prob.issues.containsByKey(i.key)||prob.issues.push(i)})})}),scope.hasChangedProblems=!1,scope.open=function(problem){scope.currentProblem=problem,scope.ourUser.problems.containsByKey(problem.key)||scope.ourUser.problems.push(newProblem(problem));var ourUserCurrentProblem=scope.ourUser.problems.getByKey(problem.key),numIssuesOnModalOpen=ourUserCurrentProblem.issues.length,modalInstance=$modal.open({animation:"true",templateUrl:"modules/problems/partials/problem-modal.client.view.html",controller:"ModalProblemController",size:"md",scope:scope,backdrop:"static",resolve:{issues:function(){return scope.currentProblem.issues},userProblem:function(){return ourUserCurrentProblem}}});modalInstance.result.then(function(){scope.currentProblem.numChecked=ourUserCurrentProblem.issues.length,numIssuesOnModalOpen!=ourUserCurrentProblem.issues.length&&(scope.hasChangedProblems=!0),0==ourUserCurrentProblem.issues.length&&scope.ourUser.problems.removeByKey(ourUserCurrentProblem.key)},function(){0==ourUserCurrentProblem.issues.length&&scope.ourUser.problems.removeByKey(ourUserCurrentProblem.key)})}}}}]),angular.module("onboarding").directive("problemOtherItem",["$timeout","$filter",function($timeout,$filter){return{template:"",restrict:"A",link:function(scope,element,attrs){element.on("touchstart touchend",function(e){e.preventDefault(),e.stopPropagation()}),scope.addMore=!1,scope.toggleOther=function(event){event.preventDefault(),event.stopPropagation(),scope.addMore=!0,scope.newOther={key:"",emergency:!1},element.find("input")[0].focus(),$timeout(function(){var objDiv=document.querySelector(".selecter-options");objDiv.scrollTop=objDiv.scrollHeight})},scope.addOther=function(event){event.stopPropagation(),!scope.userProblem.issues.containsByKey(scope.newOther.key)&&scope.newOther.key.length&&(scope.newOther.key=$filter("titlecase")(scope.newOther.key),scope.issues.push(scope.newOther),scope.userProblem.issues.push(scope.newOther),scope.newOther={key:"",emergency:!1},scope.addMore=!1,$timeout(function(){var objDiv=document.querySelector(".selecter-options");objDiv.scrollTop=objDiv.scrollHeight}))}}}}]),angular.module("problems").filter("problemTitle",function(){return function(input){switch(input){case"bedrooms":return"Bedrooms";case"kitchen":return"Kitchen";case"bathroom":return"Bathrooms";case"entireHome":return"Entire Home";case"livingRoom":return"Living Room";case"publicAreas":return"Public Areas";case"landlordIssues":return"Landlord Issues";default:return""}}}),angular.module("onboarding").factory("Problems",["$http","$q","Authentication",function($http,$q,Authentication){var requestLocalFile=function(){var deferred=$q.defer();return $http.get("data/checklist.json").then(function(response){deferred.resolve(response.data)},function(err){deferred.reject(err)}),deferred.promise};return{getLocalFile:function(){return requestLocalFile()},getUserIssuesByKey:function(key){return Authentication.user.problems.getByKey(key).issues},getUserProblems:function(){for(var problems=[],i=0;i<Authentication.user.problems.length;i++)problems.push(Authentication.user.problems[i].title);return problems}}}]),angular.module("tutorial").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.when("/tutorial","/tutorial/intro"),$stateProvider.state("tutorial",{url:"/tutorial",templateUrl:"modules/tutorial/views/tutorial.client.view.html","abstract":!0,data:{disableBack:!0}}).state("tutorial.intro",{url:"/intro",templateUrl:"modules/tutorial/partials/intro.client.view.html"}).state("tutorial.main",{url:"/main",templateUrl:"modules/tutorial/partials/tutorial.client.view.html",globalStyles:"no-header-spacing white-bg"})}]),angular.module("tutorial").controller("TutorialController",["$scope","$sce",function($scope,$sce){
$scope.slides=[{image:"modules/tutorial/img/1TakeAction.png",text:$sce.trustAsHtml("The more evidence you upload, the stronger your case will be. Start with the <strong>Take Action</strong> section to add photos, file 311 complaints and send notices to your landlord."),title:"Gather Evidence"},{image:"modules/tutorial/img/2StatusUpdate.png",text:$sce.trustAsHtml("Add a <strong>Status Update</strong> at any time from the dashboard. This will help you keep a log of any updates or communication with your landlord."),title:"Add Status Updates"},{image:"modules/tutorial/img/3CaseHistory.png",text:$sce.trustAsHtml("Everything you do is saved in your <strong>Case History</strong>. You can print it for housing court or share it with neighbors and advocates by using the Share Link."),title:"Share Your Case History"},{image:"modules/tutorial/img/4KYR.png",text:$sce.trustAsHtml("It's important to stay informed about your rights as a tenant. Go to <strong>Know Your Rights</strong> for articles and links to get more information."),title:"Know Your Rights"}]}]),angular.module("users").config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push(["$rootScope","$q","$location","Authentication",function($rootScope,$q,$location,Authentication){return{responseError:function(rejection){switch(rejection.status){case 401:Authentication.user=null,$location.path("signin");break;case 403:$location.path("not-found")}return $q.reject(rejection)}}}])}]),angular.module("users").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.when("/settings","/settings/profile"),$stateProvider.state("settings",{url:"/settings",controller:"SettingsController",templateUrl:"modules/users/views/settings/settings.client.view.html","abstract":!0}).state("settings.profile",{url:"/profile",templateUrl:"modules/users/views/settings/landing.client.view.html",settings:!0}).state("settings.edit",{url:"/edit",templateUrl:"modules/users/views/settings/edit-profile.client.view.html",settings:!0}).state("settings.password",{url:"/password",templateUrl:"modules/users/views/settings/change-password.client.view.html",settings:!0}).state("settings.phone",{url:"/phone",templateUrl:"modules/users/views/settings/edit-phone.client.view.html",settings:!0}),$stateProvider.state("signin",{url:"/signin",templateUrl:"modules/users/views/authentication/signin.client.view.html"}).state("forgot",{url:"/password/forgot",templateUrl:"modules/users/views/password/forgot-password.client.view.html"}).state("reset-invalid",{url:"/password/reset/invalid",templateUrl:"modules/users/views/password/reset-password-invalid.client.view.html"}).state("reset-success",{url:"/password/reset/success",templateUrl:"modules/users/views/password/reset-password-success.client.view.html"}).state("reset",{url:"/password/reset/:token",templateUrl:"modules/users/views/password/reset-password.client.view.html"})}]),angular.module("users").controller("AuthenticationController",["$rootScope","$scope","$http","$state","Authentication",function($rootScope,$scope,$http,$state,Authentication){$scope.authentication=Authentication,$scope.authentication.user&&$state.go("home"),$scope.signin=function(){$http.post("/api/auth/signin",$scope.credentials).success(function(response){$scope.authentication.user=response,$state.go("home")}).error(function(response){$scope.error=response.message})}}]),angular.module("users").controller("PasswordController",["$scope","$stateParams","$http","$location","Authentication",function($scope,$stateParams,$http,$location,Authentication){$scope.authentication=Authentication,$scope.authentication.user&&$location.path("/"),$scope.askForPasswordReset=function(){console.log($scope.credentials),$scope.success=$scope.error=null,$http.post("/api/auth/forgot",$scope.credentials).success(function(response){$scope.credentials=null,$scope.success=response.message}).error(function(response){$scope.credentials=null,$scope.error=response.message})},$scope.resetUserPassword=function(){$scope.success=$scope.error=null,console.log($stateParams),$http.post("/api/auth/reset/"+$stateParams.token,$scope.passwordDetails).success(function(response){$scope.passwordDetails=null,Authentication.user=response,$location.path("/api/password/reset/success")}).error(function(response){$scope.error=response.message})}}]),angular.module("users").controller("SettingsController",["$scope","$http","$location","$state","$filter","Users","Authentication","$rootScope",function($scope,$http,$location,$state,$filter,Users,Authentication,$rootScope){$scope.passwordVerified=!1,$scope.successfulUpdate=!1,$scope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){$scope.user=Authentication.user,"settings.profile"===fromState.name&&($scope.successfulUpdate=!1)}),$scope.hasConnectedAdditionalSocialAccounts=function(provider){for(var i in $scope.user.additionalProvidersData)return!0;return!1},$scope.isConnectedSocialAccount=function(provider){return $scope.user.provider===provider||$scope.user.additionalProvidersData&&$scope.user.additionalProvidersData[provider]},$scope.removeUserSocialAccount=function(provider){$scope.success=$scope.error=null,$http["delete"]("api/users/accounts",{params:{provider:provider}}).success(function(response){$scope.success=!0,$scope.user=Authentication.user=response}).error(function(response){$scope.error=response.message})},$scope.signOut=function(){$http.get("api/auth/signout").then(function(success){},function(err){console.log(err)})},$scope.updateUserProfile=function(isValid){if(isValid){$scope.success=$scope.error=null;var user=new Users($scope.user);isValid?($scope.userError=!1,$rootScope.loading=!0,user.$update(function(response){$rootScope.loading=!1,$scope.user=Authentication.user=response,$state.go("settings.profile"),$scope.passwordVerified=!1,$scope.successfulUpdate=!0},function(err){$rootScope.loading=!1,console.log(err),$scope.error=err})):$scope.userError=!0}},$scope.changeUserPassword=function(){$scope.success=$scope.error=null,$http.post("api/users/password",$scope.passwordDetails).success(function(response){$scope.success=!0,$scope.passwordDetails=null,$state.go("settings.profile")}).error(function(response){$scope.error=response.message})},$scope.verifyPassword=function(password){$http.post("api/users/verify-password",{password:password}).success(function(response){$scope.passwordVerified=!0,$scope.user.phone=""}).error(function(err){$scope.passwordError=!0,$scope.errorMessage=err.message})}}]),angular.module("core").directive("toggleSharing",["Users","Authentication",function(Users,Authentication){return{restrict:"A",scope:!1,link:function(scope,elm,attrs){Authentication.user&&Authentication.user.sharing.enabled&&(elm[0].querySelector("input").checked=!0),elm.bind("touchstart click",function(event){event.stopPropagation(),event.preventDefault(),elm[0].querySelector("input").checked=!elm[0].querySelector("input").checked,Authentication.user?Users.toggleSharing(function(user){Authentication.user=user}):scope.newUser&&(scope.newUser.sharing.enabled=elm[0].querySelector("input").checked,scope.$apply())})}}}]),angular.module("users").factory("Authentication",[function($resource){var _this=this;return _this._data={user:window.user},_this._data}]),angular.module("users").factory("Users",["$resource",function($resource){return $resource("api/users",{},{update:{method:"PUT"},toggleSharing:{method:"GET",url:"api/users/public"},updateChecklist:{method:"PUT",url:"api/users/checklist"}})}]);