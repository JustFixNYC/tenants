"use strict";var ApplicationConfiguration=function(){var applicationModuleName="justfix",applicationModuleVendorDependencies=["ngResource","ngAnimate","ngCookies","ui.router","ui.bootstrap","ui.select","ui.utils","ng.deviceDetector","ngFileUpload","bootstrapLightbox","angularLazyImg","duScroll","pascalprecht.translate","tmh.dynamicLocale","angular.filter","angular-clipboard"],registerModule=function(moduleName,dependencies){angular.module(moduleName,dependencies||[]),angular.module(applicationModuleName).requires.push(moduleName)};return{applicationModuleName:applicationModuleName,applicationModuleVendorDependencies:applicationModuleVendorDependencies,registerModule:registerModule}}();angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider",function($locationProvider){$locationProvider.hashPrefix("!"),$locationProvider.html5Mode(!0)}]).config(["$compileProvider",function($compileProvider){$compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|tel|sms|mailto):/)}]).constant("LOCALES",{locales:{en_US:"English",es_mx:"Español"},preferredLocale:"en_US"}).config(function($translateProvider,$translateSanitizationProvider){$translateProvider.useStaticFilesLoader({prefix:"languages/locale-",suffix:".json"}),$translateProvider.preferredLanguage("en_US"),$translateProvider.fallbackLanguage("en_US"),$translateProvider.useLocalStorage(),$translateProvider.useSanitizeValueStrategy(null)}).config(function(tmhDynamicLocaleProvider){tmhDynamicLocaleProvider.localeLocationPattern("lib/angular-i18n/angular-locale_{{locale}}.js")}).run(function(){Array.prototype.containsByKey=Array.prototype.containsByKey||function(key){var i,l=this.length;for(i=0;i<l;i++)if(this[i].key==key)return!0;return!1},Array.prototype.getByKey=Array.prototype.getByKey||function(key){var i,l=this.length;for(i=0;i<l;i++)if(this[i].key==key)return this[i];return null},Array.prototype.removeByKey=Array.prototype.removeByKey||function(key){var i,l=this.length;for(i=l-1;i>=0;i--)this[i].key==key&&this.splice(i,1)}}).run(function($rootScope,$location,LocaleService){var setHeaderState=function(name){switch(name){case"landing":case"oldLanding":$rootScope.headerInner=!1,$rootScope.headerLightBG=!1;break;case"manifesto":$rootScope.headerInner=!1,$rootScope.headerLightBG=!0;break;default:$rootScope.headerInner=!0,$rootScope.headerLightBG=!1}};$rootScope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){$rootScope.state=toState.name,toState.data&&toState.data.disableBack?$rootScope.showBack=!1:$rootScope.showBack=!0,setHeaderState(toState.name)})}).run(function($rootScope,$location,LocaleService,$translate){var langQuery=(navigator.language||navigator.userLanguage,$location.search().lang),userLang=navigator.language||navigator.userLanguage;return $location.search().hasOwnProperty("lang")?void("es"===langQuery||"es-mx"===langQuery?LocaleService.setLocaleByName("es_mx"):"en"===langQuery||"en-us"===langQuery?LocaleService.setLocaleByName("en_US"):LocaleService.checkIfLocaleIsValid(langQuery)?LocaleService.setLocaleByName(langQuery):$location.search("lang","")):void(LocaleService.checkIfLocaleIsValid(userLang)&&LocaleService.setLocaleByName(userLang))}),angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),FastClick&&FastClick.attach(document.body),angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])}),ApplicationConfiguration.registerModule("actions"),ApplicationConfiguration.registerModule("activity"),ApplicationConfiguration.registerModule("admin"),ApplicationConfiguration.registerModule("advocates"),ApplicationConfiguration.registerModule("core"),ApplicationConfiguration.registerModule("findhelp"),ApplicationConfiguration.registerModule("kyr"),ApplicationConfiguration.registerModule("onboarding"),ApplicationConfiguration.registerModule("problems"),ApplicationConfiguration.registerModule("tutorial"),ApplicationConfiguration.registerModule("users"),angular.module("actions").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$stateProvider.state("listActions",{url:"/take-action",templateUrl:"modules/actions/views/list-actions.client.view.html",data:{protected:!0},user:"tenant"})}]),angular.module("actions").controller("ActionsController",["$scope","$filter","Authentication","Actions","Activity",function($scope,$filter,Authentication,Actions,Activity){$scope.user=Authentication.user,$scope.userCompletedDetails=function(){return!!$scope.user.actionFlags&&$scope.user.actionFlags.indexOf("allInitial")!==-1},$scope.list=function(){Actions.query(function(actions){$scope.onceActions=$filter("filter")(actions,{$:"once"},!0),$scope.recurringActions=$filter("filter")(actions,{$:"recurring"},!0),$scope.legalActions=$filter("filter")(actions,{$:"legal"},!0)})}}]),angular.module("actions").controller("AddDetailsController",["$scope","$filter","$modalInstance","newActivity","Problems",function($scope,$filter,$modalInstance,newActivity,Problems,close){$scope.newActivity=newActivity,$scope.issues=Problems.getUserIssuesByKey($scope.newActivity.key),$scope.newActivity.keyTitle="checklist."+$scope.newActivity.key+".title",$scope.newActivity.problems=[{issues:JSON.parse(JSON.stringify($scope.issues,function(key,value){if("$$hashKey"!==key&&"_id"!==key)return value}))}],$scope.formSubmitted=!1,$scope.onFileSelect=function(files){console.log(files)},$scope.done=function(isValid){$scope.formSubmitted=!0,isValid&&($scope.newActivity.fields.push({title:"modules.activity.views.listActivity.experienced",value:$filter("date")($scope.newActivity.startDate,"longDate")}),$modalInstance.close({newActivity:$scope.newActivity}))},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}]),angular.module("actions").controller("ComplaintLetterController",["$rootScope","$scope","$sce","$timeout","$modalInstance","newActivity","Pdf","Messages","Authentication","$window",function($rootScope,$scope,$sce,$timeout,$modalInstance,newActivity,Pdf,Messages,Authentication,$window){$scope.user=Authentication.user,$scope.newActivity=newActivity,$scope.newActivity.fields=[],$scope.landlord={name:"",address:""},$scope.accessDates=[],$scope.accessDates.push(""),$scope.status={},$scope.status.created=!1,$scope.status.state="landlordInfo",$scope.addAccessDate=function(){$scope.accessDates.push("")};var timerCountdown=30,setCreationTimer=function(){$timeout(function(){$scope.status.created||($scope.status.state="error",Rollbar.warning("Request for the letter took too long to respond"),$scope.errorCode="Request for the letter took too long to respond")},1e3*timerCountdown)};$scope.generatePreview=function(){$scope.msgPreview=Messages.getLandlordEmailMessage($scope.landlord.name,$scope.accessDates),$scope.status.state="msgPreview"},$scope.createLetter=function(){$scope.status.state="loading",Pdf.createComplaint($scope.landlord,$scope.accessDates).then(function(data){setCreationTimer(),$scope.status.state="msgSuccess",$scope.status.created=!0,$scope.letterUrl=data,$scope.newActivity.fields.push({title:"letterURL",value:data})},function(error){$scope.status.state="error",Rollbar.error("Error with letter generation"),$scope.errorCode=error})},$scope.sendLetter=function(){Rollbar.info("New Letter of Complaint!",{name:Authentication.user.fullName,phone:Authentication.user.phone,letterUrl:$scope.letterUrl,landlordName:$scope.landlord.name,landlordAddress:$scope.landlord.address}),$scope.newActivity.fields.push({title:"landlordName",value:$scope.landlord.name}),$scope.newActivity.fields.push({title:"landlordAddress",value:$scope.landlord.address}),$scope.status.state="letterSuccess"},$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.done=function(){$modalInstance.close({newActivity:$scope.newActivity,modalError:$scope.status.error})}}]),angular.module("actions").controller("ContactSuperController",["$scope","$modalInstance","deviceDetector","Messages","newActivity",function($scope,$modalInstance,deviceDetector,Messages,newActivity){$scope.newActivity=newActivity,$scope.formSubmitted=!1,$scope.done=function(isValid,event){$scope.formSubmitted=!0,console.log(event),isValid&&event.target.href?($modalInstance.close({newActivity:$scope.newActivity}),window.location.href=event.target.href):console.log("no href?")},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}]),angular.module("actions").controller("DecreasedServicesController",function($scope,$modalInstance,newActivity){$scope.newActivity=newActivity,$scope.addUpdate=function(){$modalInstance.close({newActivity:$scope.newActivity})},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}),angular.module("actions").controller("HpactionController",function($scope,$modalInstance,newActivity){$scope.newActivity=newActivity,$scope.done=function(){$modalInstance.close({newActivity:$scope.newActivity})},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}),angular.module("actions").controller("MessageLandlordController",["$scope","$modalInstance","Messages","newActivity",function($scope,$modalInstance,Messages,newActivity){$scope.newActivity=newActivity,$scope.email={},$scope.email.content=Messages.getLandlordEmailMessage(),$scope.done=function(){$scope.email.contact=$scope.email.landlord+"?subject="+Messages.getLandlordEmailSubject(),$scope.emailHref="mailto:"+encodeURI($scope.email.contact+"&body="+$scope.email.content),$modalInstance.close({newActivity:$scope.newActivity}),window.location.href=$scope.emailHref},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}]),angular.module("actions").controller("RentalHistoryController",["$scope","$modalInstance","Messages","newActivity",function($scope,$modalInstance,Messages,newActivity){$scope.newActivity=newActivity,$scope.emailContent=Messages.getRentalHistoryMessage(),$scope.emailHref="mailto:"+encodeURI("rentinfo@nyshcr.org?subject=Request For Rental History&body="+$scope.emailContent),$scope.done=function(){$modalInstance.close({newActivity:$scope.newActivity}),window.location.href=$scope.emailHref},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}]),angular.module("actions").directive("compileTemplate",["$compile","$parse","$sce","$translate",function($compile,$parse,$sce,$translate){return{link:function(scope,element,attr){var parsed=$parse(attr.ngBindHtml),getStringValue=function(){return(parsed(scope)||"").toString()};scope.$watch(getStringValue,function(val){val.indexOf("modules")!==-1?$translate(val).then(function(newVal){element.html(newVal),$compile(element,null,-9999)(scope)}):(element.html(val),$compile(element,null,-9999)(scope))})}}}]),angular.module("actions").directive("statusUpdate",["$rootScope","$filter","$sce","$timeout","Activity","Actions","Problems",function($rootScope,$filter,$sce,$timeout,Activity,Actions,Problems){return{restrict:"E",templateUrl:"modules/actions/partials/status-update.client.view.html",controller:function($scope,$element,$attrs){},link:function(scope,element,attrs){scope.problems=Problems.getUserProblems(),scope.status={expanded:!1,extraExpanded:!1,tagging:!1,closeAlert:!1,closeErrorAlert:!0,formSubmitted:!1,completed:!1},$rootScope.expandStatus&&(scope.status.expanded=!0,scope.status.extraExpanded=!0,$timeout(function(){element[0].querySelector("textarea").focus()},0)),$rootScope.takeActionAlert||(scope.status.expanded=!0,$timeout(function(){element[0].querySelector("textarea").focus()},0)),scope.newActivity={date:"",title:"modules.activity.other.statusUpdate",key:"statusUpdate",relatedProblems:[],photos:[]},scope.expand=function(event){event.preventDefault(),scope.status.expanded=!0},scope.toggleTagging=function(){scope.status.tagging=!scope.status.tagging},scope.selectProblem=function(problem){if(this.isSelectedProblem(problem)){var i=scope.newActivity.relatedProblems.indexOf(problem);scope.newActivity.relatedProblems.splice(i,1)}else scope.newActivity.relatedProblems.push(problem)},scope.isSelectedProblem=function(problem){return scope.newActivity.relatedProblems.indexOf(problem)!==-1},scope.addPhoto=function(file){file&&(scope.newActivity.photos.push(file),file.lastModifiedDate&&(scope.newActivity.date=file.lastModifiedDate))},scope.closeAlert=function(){scope.status.closeAlert=!0},scope.createActivity=function(isValid){if(scope.status.formSubmitted=!0,isValid){$rootScope.loading=!0,console.time("statusUpdate");var activity=new Activity(scope.newActivity);activity.$save(function(response){console.timeEnd("statusUpdate"),$rootScope.loading=!1,scope.status.completed=!0,scope.status.formSubmitted=!1,scope.status.expanded=!1,scope.newActivity={date:"",title:"modules.activity.other.statusUpdate",key:"statusUpdate",relatedProblems:[],photos:[]}},function(errorResponse){$rootScope.loading=!1,scope.error=errorResponse.data.message,scope.status.closeErrorAlert=!1})}}}}}]),angular.module("actions").directive("toDoItem",["$rootScope","$modal","$sce","$compile","$filter","$timeout","Authentication","Activity","Actions","$translate",function($rootScope,$modal,$sce,$compile,$filter,$timeout,Authentication,Activity,Actions,$translate){return{restrict:"E",templateUrl:"modules/actions/partials/to-do-item.client.view.html",controller:function($scope,$element,$attrs){$scope.user=Authentication.user,$scope.filterTitleHTML=$scope.action.title,$scope.filterContentHTML=$scope.action.content,$scope.filterButtonTitleHTML=$scope.action.cta.buttonTitle,$scope.closeErrorAlert=!0},link:function(scope,element,attrs){scope.followUpSubmitted=!1,scope.action.completed||(scope.action.completed=!1),scope.newActivity={title:scope.action.activityTitle,key:scope.action.key},scope.action.isFollowUp&&scope.action.startDate&&(scope.newActivity.startDate=new Date(scope.action.startDate)),scope.newActivity.fields=[],scope.action.followUp&&scope.action.followUp.fields&&angular.forEach(scope.action.followUp.fields,function(field,idx){scope.newActivity.fields.push({title:field.title})});var getSection=function(type){switch(type){case"once":return scope.onceActions;case"recurring":return scope.recurringActions;case"legal":return scope.legalActions;default:return void console.error("this shouldn't happen!")}};scope.isModal=function(){switch(scope.action.cta.type){case"initialContent":return!0;case"modal":return!0;default:return!1}},scope.openModal=function(){var modalInstance=$modal.open({templateUrl:"modules/actions/partials/modals/"+scope.action.cta.template,controller:scope.action.cta.controller,backdrop:"static",resolve:{newActivity:function(){return scope.newActivity}}});modalInstance.opened.then(function(){angular.element(document).find("html").css({overflow:"hidden",position:"fixed"})}),modalInstance.result.then(function(result){angular.element(document).find("html").css({overflow:"auto",position:"static"}),scope.newActivity=result.newActivity,scope.action.hasFollowUp?scope.triggerFollowUp(!0):result.modalError||scope.createActivity(!0,!1)},function(){angular.element(document).find("html").css({overflow:"auto",position:"static"})})},scope.triggerFollowUp=function(hasDoneAction,url,type){hasDoneAction&&(scope.newActivity.startDate=scope.action.startDate=new Date),scope.action.$followUp({type:"add"}),url&&"tel"===type?window.location.href=url:url&&"link"===type&&window.open(url,"_blank")},scope.completeAction=function(){scope.action.completed=!0,scope.action.closeAlert=!1},scope.cancelFollowUp=function(){scope.action.$followUp({type:"remove"})},scope.closeAlert=function(){scope.action.closeAlert=!0;var section=getSection(scope.action.type);section.splice(scope.$index,1)};scope.createActivity=function(isValid,addDOA){if(scope.action.hasFollowUp&&(scope.followUpSubmitted=!0),isValid){addDOA&&scope.newActivity.fields.unshift({title:"modules.actions.partials.toDoItem.occurredDate",value:$filter("date")(scope.newActivity.startDate,"longDate")}),$rootScope.loading=!0,console.time("toDoItem");var activity=new Activity(scope.newActivity);activity.$save(function(response){console.timeEnd("toDoItem"),$rootScope.loading=!1,scope.completeAction();var newActions=Actions.query({key:scope.newActivity.key},function(){newActions.forEach(function(action){var section=getSection(action.type);section.push(action)})})},function(errorResponse){$rootScope.loading=!1,scope.error=errorResponse.data.message,scope.closeErrorAlert=!1})}}}}}]),angular.module("actions").factory("Actions",["$resource",function($resource){return $resource("api/actions",{},{followUp:{method:"POST"}})}]),angular.module("actions").factory("Messages",["$http","$q","$filter","$timeout","$location","Authentication","$translate","LocaleService",function($http,$q,$filter,$timeout,$location,Authentication,$translate,LocaleService){var user=Authentication.user,getShareMessage=function(type){var message;switch(type){case"share":message="Hello, this is "+user.fullName+" at "+user.address+", Apt. "+user.unit+". I'm experiencing issues with my apartment and would like to get them resolved. A link to my Case History can be found at https://"+$location.host()+"/share/"+user.sharing.key+". Thank you!";break;case"friendShare":message="I am using JustFix.nyc to take action on my housing issues! Click here to sign up: https://justfix.nyc/signup";break;default:message="Hello, this is "+user.fullName+" at "+user.address+", Apt. "+user.unit+". I'm experiencing issues with my apartment and would like to get them resolved. Please contact me as soon as possible at this phone number. Thank you!"}return message},getRentalHistoryMessage=function(){var message="Hello,\n\nI, "+user.fullName+", am currently residing at "+user.address+", Apt. "+user.unit+" in "+user.borough+", NY  and would like to request the rental history for this apartment. Any information you can provide me would be greatly appreciated.\n\nThank you, \n\n"+user.fullName;return message},getLandlordEmailMessage=function(landlordName,accessDates){var message="";message+=landlordName.length?"Dear "+landlordName+",\n\n":"To whom it may regard,\n\n",message+="I am requesting the following repairs in my apartment referenced below [and/or] in the public areas of the building:\n\n";for(var problemsContent="",i=0;i<user.problems.length;i++){var prob=user.problems[i];if("landlordIssues"!==prob.key){problemsContent+=$translate.instant(prob.title,void 0,void 0,"en_US")+":\n";for(var j=0;j<prob.issues.length;j++){var issue=$translate.instant(prob.issues[j].key,void 0,void 0,"en_US");problemsContent+=" - "+issue,prob.issues[j].emergency&&(problemsContent+=" (FIX IMMEDIATELY)"),problemsContent+="\n"}problemsContent+="\n"}}if(message+=problemsContent,accessDates.length&&accessDates[0]instanceof Date){message+="Access Dates\n",message+="Below are some access dates provided for when repairs can be made. Please contact (using the information provided below) in order to make arrangements. Anyone coming to perform repairs should arrive no later than 12pm during the provided dates.\n\n";for(var k=0;k<accessDates.length;k++)message+="- "+$filter("date")(accessDates[k],"longDate")+"\n";message+="\n"}return message+='I have already contacted the person responsible for making repairs on on several occasions, but the issue has not been resolved. In the meantime, I have recorded evidence of the violation[s] should legal action be necessary. If these repairs are not made immediately I will have no choice but to use my legal remedies to get the repairs done.\n\nPursuant to NYC Admin Code § 27-2115 an order of civil penalties for all existing violations for which the time to correct has expired is as follows:\n\n"C" violation:\n$50 per day per violation (if 1-5 units)\n$50-$150 one-time penalty per violation plus $125 per day (5 or more units)\n\n“B” Violation:\n$25-$100 one-time penalty per violation plus $10 per day\n\n“A” Violation:\n$10-$50 one-time penalty per violation\n\nPlease be advised that NYC Admin Code § 27-2115 provides a civil penalty where a person willfully makes a false certification of correction of a violation per violation falsely certified.\n\nPlease contact me as soon as possible to arrange a time to have these repairs made at the number provided below.',message+="\n\nRegards,\n"+user.fullName+"\n"+user.address+"\nApt. "+user.unit+"\n"+user.borough+", NY \n"+$filter("tel")(user.phone)},getLandlordEmailSubject=function(){return"Formal notice of repairs needed at "+user.address+" Unit "+user.unit};return{getShareMessage:getShareMessage,getRentalHistoryMessage:getRentalHistoryMessage,getLandlordEmailMessage:getLandlordEmailMessage,getLandlordEmailSubject:getLandlordEmailSubject}}]),angular.module("actions").factory("Pdf",["$http","$q","Authentication","$filter","$translate",function($http,$q,Authentication,$filter,$translate){var user=Authentication.user,assemble=function(landlordName,landlordAddr){var zip,assembledObject={issues:[],emergency:!1};zip=user.geo?user.geo.zip:"",assembledObject.tenantInfo={phone:$filter("tel")(user.phone),name:user.fullName,address:user.address+" "+user.unit+" <br> "+user.borough+" <br> New York, "+zip},assembledObject.landlordInfo={name:landlordName.length?"Dear "+landlordName:"To whom it may concern",address:landlordAddr.length?landlordAddr:""};for(var i=0;i<user.problems.length;i++)if("landlordIssues"!==user.problems[i].key){var problemPush=angular.copy(user.problems[i]);problemPush.title=$translate.instant(problemPush.title,void 0,void 0,"en_US"),problemPush.issues.map(function(curr,idx,arr){curr.key=$translate.instant(curr.key,void 0,void 0,"en_US"),curr.emergency===!0&&(assembledObject.emergency=!0)}),assembledObject.issues.push(problemPush)}return assembledObject},createComplaint=function(landlord,accessDates){var deferred=$q.defer(),assembledObject=assemble(landlord.name,landlord.address);return assembledObject.accessDates=accessDates,$http({method:"POST",url:"//pdf-microservice.herokuapp.com/complaint-letter",data:assembledObject}).then(function(response){Authentication.user.complaintUrl=response.data,deferred.resolve(response.data)},function(error){deferred.reject(error)}),deferred.promise};return{createComplaint:createComplaint}}]),angular.module("activity").config(["$stateProvider","$urlRouterProvider","LightboxProvider",function($stateProvider,$urlRouterProvider,LightboxProvider){LightboxProvider.templateUrl="modules/activity/partials/lightbox-template.html",$stateProvider.state("listActivity",{url:"/your-case",templateUrl:"modules/activity/views/list-activity.client.view.html",data:{protected:!0},user:"tenant"}).state("showPublic",{url:"/share/:key",templateUrl:"modules/activity/views/list-activity-public.client.view.html",controller:"ActivityPublicController",resolve:{user:["Activity","$stateParams",function(Activity,$stateParams){return Activity.public({key:$stateParams.key}).$promise}]}}).state("print",{url:"/print/:key",templateUrl:"modules/activity/views/print.client.view.html",data:{disableBack:!0},globalStyles:"clear-nav"})}]),angular.module("activity").controller("ActivityPublicController",["$scope","$stateParams","$state","$http","$filter","Activity","Lightbox","user",function($scope,$stateParams,$state,$http,$filter,Activity,Lightbox,user){$scope.shareID=$stateParams.key,$scope.shareID||$state.go("home"),$scope.photos=[],$scope.user=user,$scope.activities=$scope.user.activity,$scope.activities.forEach(function(act){$scope.photos=$scope.photos.concat(act.photos)}),$scope.activityTemplate=function(key){return $filter("activityTemplate")(key)},$scope.compareDates=function(start,created){var startDate=new Date(start).setHours(0,0,0,0),createdDate=new Date(created).setHours(0,0,0,0);return startDate!==createdDate},$scope.openLightboxModal=function(photos,index){Lightbox.openModal(photos,index)}}]),angular.module("activity").controller("ActivityController",["$scope","$location","$http","$filter","deviceDetector","Authentication","Users","Activity","Lightbox",function($scope,$location,$http,$filter,deviceDetector,Authentication,Users,Activity,Lightbox){$scope.authentication=Authentication,$scope.location=$location.host(),$scope.shareCollapsed=!1,$scope.isDesktop=deviceDetector.isDesktop(),$scope.photos=[],$scope.list=function(){$scope.activities=$scope.authentication.user.activity,$scope.activities.forEach(function(act){$scope.photos=$scope.photos.concat(act.photos)})},$scope.activityTemplate=function(key){return $filter("activityTemplate")(key)},$scope.openLightboxModal=function(photos,index){Lightbox.openModal(photos,index)}}]),angular.module("activity").controller("PrintController",["$scope","$rootScope","$filter","Activity","Authentication","$state","$stateParams",function($scope,$rootScope,$filter,Activity,Authentication,$state,$stateParams){$scope.printable=!1,$scope.reloadView=function(){$scope.printable=!1,$state.reload()},$scope.list=function(){var photoOrder=0,dataTagAndOrder=function(data){data.reverse();for(var i=0;i<data.length;i++)if(data[i].photos.length){data[i].photosExist=!0;for(var j=0;j<data[i].photos.length;j++)data[i].photos[j].order=photoOrder,photoOrder++}return data};Authentication.user&&!$stateParams.key?($scope.user=Authentication.user,$scope.activities=dataTagAndOrder($scope.user.activity)):$stateParams.key?Activity.public({key:$stateParams.key},function(data){$scope.user=data,$scope.activities=dataTagAndOrder(data.activity)},function(error){console.log(error)}):$scope.stopPrint=!0},$rootScope.headerLightBG=!0,$scope.activityTemplate=function(key){return $filter("activityTemplate")(key)},$scope.compareDates=function(start,created){var startDate=new Date(start).setHours(0,0,0,0),createdDate=new Date(created).setHours(0,0,0,0);return startDate!==createdDate},$rootScope.$on("$viewContentLoaded",function(){$scope.stopPrint||($scope.printable=!0)})}]),angular.module("activity").directive("metaMap",["$rootScope","CartoDB",function($rootScope,CartoDB){return{restrict:"E",template:'<div class="meta-map"></div>',scope:!1,link:function(scope,element,attrs){var photoLat=attrs.lat,photoLng=attrs.lng,map=L.map(element[0].children[0],{scrollWheelZoom:!1,zoomControl:!1,center:[photoLat,photoLng],zoom:15});L.Icon.Default.imagePath="/modules/core/img/leaflet";var userMarker;L.mapboxGL({accessToken:"pk.eyJ1IjoiZGFuLWthc3MiLCJhIjoiY2lsZTFxemtxMGVpdnVoa3BqcjI3d3Q1cCJ9.IESJdCy8fmykXbb626NVEw",style:"mapbox://styles/dan-kass/cilljc5nu004d9vkngyozkhzb",attributionControl:!0}).addTo(map);userMarker=L.marker([photoLat,photoLng]),userMarker.addTo(map)}}}]),angular.module("activity").filter("activityTemplate",function(){return function(input){var template="/modules/activity/partials/";switch(input){case"sendLetter":template+="complaint-letter.client.view.html";break;case"checklist":template+="checklist.client.view.html";break;default:template+="default-activity.client.view.html"}return template}}),angular.module("activity").factory("Activity",["$resource","UpdateUserInterceptor",function($resource,UpdateUserInterceptor){var objectToFormData=function(obj,form,namespace){var formKey,fd=form||new FormData;for(var property in obj)obj.hasOwnProperty(property)&&(formKey=namespace?namespace+"["+property+"]":property,"object"!=typeof obj[property]||obj[property]instanceof File||obj[property]instanceof Date?fd.append(formKey,obj[property]):objectToFormData(obj[property],fd,formKey));return fd},formDataTransform=function(data,headersGetter){return objectToFormData(data)};return $resource("api/activity",{},{save:{method:"POST",transformRequest:formDataTransform,headers:{"Content-Type":void 0},interceptor:UpdateUserInterceptor},saveManagedByID:{method:"POST",url:"api/advocates/tenants/:id",transformRequest:formDataTransform,headers:{"Content-Type":void 0}},public:{method:"GET",url:"api/activity/public"}})}]),angular.module("admin").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$stateProvider.state("admin",{url:"/admin",templateUrl:"modules/admin/views/admin.client.view.html",data:{protected:!0},user:"admin"})}]),angular.module("admin").controller("AdminController",["$scope","$q","$modal","Passwords",function($scope,$q,$modal,Passwords){$scope.newTempPassword={},$scope.createTempPassword=function(){var newPassword=new Passwords($scope.newTempPassword);newPassword.$create(function(success){$scope.tempPasswordError=!1,$scope.tempPasswordMessage="Success!"},function(error){$scope.tempPasswordError=!0,$scope.tempPasswordMessage=error.data.message})}}]),angular.module("admin").factory("Passwords",["$resource",function($resource){return $resource("api/auth/temp-password",{},{create:{method:"POST"}})}]),angular.module("advocates").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$stateProvider.state("advocateSignup",{url:"/advocate/signup",templateUrl:"modules/advocates/views/signup.client.view.html",controller:"AdvocateSignupController",abstract:!0,data:{disableBack:!0}}).state("advocateSignup.info",{url:"",templateUrl:"modules/advocates/partials/signup-info.client.view.html",globalStyles:"white-bg"}).state("advocateSignup.details",{url:"/create",templateUrl:"modules/advocates/partials/signup-details.client.view.html"}).state("advocateSignup.referral",{url:"/referral",templateUrl:"modules/advocates/partials/signup-referral.client.view.html"}).state("newTenantSignup",{url:"/advocate/tenant/new",templateUrl:"modules/advocates/views/new-tenant.client.view.html",controller:"NewTenantSignupController",abstract:!0,user:"advocate",data:{disableBack:!0}}).state("newTenantSignup.problems",{url:"/checklist",templateUrl:"modules/advocates/partials/new-tenant-problems.client.view.html"}).state("newTenantSignup.details",{url:"/personal",templateUrl:"modules/advocates/partials/new-tenant-details.client.view.html"}).state("advocateHome",{url:"/advocate",templateUrl:"modules/advocates/views/home.client.view.html",controller:"AdvocateController",globalStyles:"fluid-container",user:"advocate",data:{disableBack:!0},resolve:{tenants:["Advocates",function(Advocates){return Advocates.query().$promise}]}}).state("advocateHelp",{url:"/advocate/information",templateUrl:"modules/advocates/views/help.client.view.html",controller:"AdvocateHelpController",user:"advocate"}).state("manageTenant",{url:"/advocate/manage/:id",templateUrl:"modules/advocates/views/manage-tenant.client.view.html",controller:"ManageTenantController",user:"advocate",abstract:!0,resolve:{tenant:["Advocates","$stateParams",function(Advocates,$stateParams){return Advocates.getTenantByCurrentOrId($stateParams.id)}]}}).state("manageTenant.home",{url:"",templateUrl:"modules/advocates/partials/manage-tenant-home.client.view.html",controller:"ManageTenantHomeController"}).state("manageTenant.problems",{url:"/problems",templateUrl:"modules/advocates/partials/manage-tenant-problems.client.view.html",controller:"ManageTenantProblemsController"})}]),angular.module("advocates").controller("AdvocateHelpController",["$rootScope","$scope","$state","$location","$timeout","$filter","Authentication","Advocates","$http","$modal",function($rootScope,$scope,$state,$location,$timeout,$filter,Authentication,Advocates,$http,$modal){$scope.user=Authentication.user}]),angular.module("advocates").controller("AdvocateSignupController",["$rootScope","$scope","$state","$location","$filter","Authentication","$http","$modal",function($rootScope,$scope,$state,$location,$filter,Authentication,$http,$modal){$scope.authentication=Authentication,$scope.newAdvocateUser={},"undefined"!=typeof DEBUG&&1==DEBUG&&($scope.newAdvocateUser={firstName:"Jane",lastName:"Doe",password:"password",phone:(Math.floor(9999999999*Math.random())+1111111111).toString(),code:"janedoe",email:"jane@westsidetenants.org",contactPhone:"8459781262",organization:"Westside Tenants"},$scope.pw2="password"),$scope.userError=!1,$scope.toReferralStep=function(isValid){isValid?$state.go("advocateSignup.referral"):$scope.userError=!0},$scope.createAdvocate=function(isValid){"undefined"!=typeof DEBUG&&1==DEBUG&&console.log("create account pre save",$scope.newAdvocateUser),
isValid?($scope.newAdvocateUser.firstName=$filter("titlecase")($scope.newAdvocateUser.firstName),$scope.newAdvocateUser.lastName=$filter("titlecase")($scope.newAdvocateUser.lastName),$scope.userError=!1,$rootScope.loading=!0,$http.post("/api/advocates/signup",$scope.newAdvocateUser).success(function(response){$rootScope.loading=!1,$scope.authentication.user=response,"undefined"!=typeof DEBUG&&1==DEBUG&&console.log("create account post save",response),$state.go("advocateHome")}).error(function(err){$rootScope.loading=!1,$scope.error=err})):$scope.userError=!0}}]),angular.module("advocates").controller("AdvocateController",["$rootScope","$scope","$state","$location","$timeout","$filter","Authentication","Advocates","$http","$modal","tenants",function($rootScope,$scope,$state,$location,$timeout,$filter,Authentication,Advocates,$http,$modal,tenants){$scope.user=Authentication.user,$scope.tenants=tenants,$scope.bbls={},$scope.currentLocation=$location.protocol()+"://"+$location.host()+(80!==$location.port()&&443!==$location.port()?":"+$location.port():""),angular.forEach(tenants,function(tenant){var streetName=tenant.geo.streetName.split(" ").map(function(i){return i.length?i[0].toUpperCase()+i.substr(1).toLowerCase():i}).join(" ");$scope.bbls[tenant.geo.bbl]=tenant.geo.streetNum+" "+streetName}),$scope.view="individual",$scope.changeView=function(newView){$scope.view=newView},$scope.copyTooltipText="Click to copy",$scope.copied=function(){$scope.copyTooltipText="Link copied!"},$scope.mouseleave=function(){$timeout(function(){$scope.copyTooltipText="Click to copy"},300)},$scope.viewTenant=function(tenant){Advocates.setCurrentTenant(tenant),$state.go("manageTenant.home",{id:tenant._id})},$scope.openReferralModal=function(){$modal.open({templateUrl:"modules/advocates/partials/sms-referral.html",controller:"SMSReferralController",backdrop:"static",resolve:{}})}}]),angular.module("advocates").controller("ManageTenantController",["$scope","$stateParams","deviceDetector","Authentication","Advocates","tenant",function($scope,$stateParams,deviceDetector,Authentication,Advocates,tenant){$scope.user=Authentication.user,$scope.device=deviceDetector,$scope.tenant=tenant}]).controller("ManageTenantHomeController",["$scope","$stateParams","$filter","deviceDetector","Advocates","Lightbox",function($scope,$stateParams,$filter,deviceDetector,Advocates,Lightbox){$scope.$watch("tenant",function(tenant){$scope.photos=[],$scope.tenant.activity.forEach(function(act){$scope.photos=$scope.photos.concat(act.photos)})},!0),$scope.isDesktop=deviceDetector.isDesktop(),$scope.activityTemplate=function(key){return $filter("activityTemplate")(key)},$scope.compareDates=function(start,created){var startDate=new Date(start).setHours(0,0,0,0),createdDate=new Date(created).setHours(0,0,0,0);return startDate!==createdDate},$scope.openLightboxModal=function(photos,index){Lightbox.openModal(photos,index)}}]).controller("ManageTenantProblemsController",["$rootScope","$scope","$state","$stateParams","Advocates","ProblemsResource",function($rootScope,$scope,$state,$stateParams,Advocates,ProblemsResource){$scope.problemsAlert=!1,$scope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams,options){if($scope.hasChangedProblems&&!toState.updated){event.preventDefault(),toState.updated=!0,$rootScope.loading=!0,$scope.problemsAlert=!1;var tenant=new ProblemsResource($scope.tenant);tenant.$updateManagedChecklist({id:$scope.tenant._id},function(response){console.log("after",response),angular.extend($scope.tenant,response),$rootScope.dashboardSuccess=!0,$rootScope.loading=!1,$state.go(toState)},function(err){$rootScope.loading=!1,$scope.problemsAlert=!0})}else toState.updated&&(toState.updated=!1)}),$scope.saveProblems=function(){console.log("before",$scope.tenant),$rootScope.loading=!0,$scope.problemsAlert=!1;var tenant=new ProblemsResource($scope.tenant);tenant.$updateManagedChecklist({id:$scope.tenant._id},function(response){console.log("after",response),angular.extend($scope.tenant,response),$rootScope.loading=!1,$state.go("manageTenant.home")},function(err){$rootScope.loading=!1,$scope.problemsAlert=!0})}}]),angular.module("advocates").controller("NewTenantSignupController",["$rootScope","$scope","$state","$location","$filter","Authentication","Advocates","$http","$modal",function($rootScope,$scope,$state,$location,$filter,Authentication,Advocates,$http,$modal){$scope.authentication=Authentication,$scope.newTenantUser={},$scope.newTenantUser.problems=[],$scope.newTenantUser.sharing={enabled:!0},"undefined"!=typeof DEBUG&&1==DEBUG&&($scope.newTenantUser={firstName:"Pete",lastName:"Best",borough:"Brooklyn",address:"654 Park Place",unit:"1RF",phone:(Math.floor(9999999999*Math.random())+1111111111).toString(),problems:[],sharing:{enabled:!0}}),$scope.userError=!1,$scope.validateNewTenant=function(isValid){isValid?($scope.userError=!1,$state.go("newTenantSignup.problems")):$scope.userError=!0},$scope.createNewTenant=function(isValid){"undefined"!=typeof DEBUG&&1==DEBUG&&console.log("create account pre save",$scope.newTenantUser),isValid?($scope.newTenantUser.firstName=$filter("titlecase")($scope.newTenantUser.firstName),$scope.newTenantUser.lastName=$filter("titlecase")($scope.newTenantUser.lastName),$scope.userError=!1,$rootScope.loading=!0,$http.post("/api/advocates/tenants/create",$scope.newTenantUser).success(function(response){$rootScope.loading=!1,"undefined"!=typeof DEBUG&&1==DEBUG&&console.log("create account post save",response),console.log(response),Advocates.setCurrentTenant(response),$state.go("manageTenant.problems",{id:response._id})}).error(function(err){$rootScope.loading=!1,$scope.error=err})):$scope.userError=!0}}]),angular.module("actions").controller("SMSReferralController",["$rootScope","$scope","$sce","$timeout","$modalInstance","Authentication","Advocates","$window","$httpParamSerializer",function($rootScope,$scope,$sce,$timeout,$modalInstance,Authentication,Advocates,$window,$httpParamSerializer){$scope.sms={phone:"",userMessage:"",message:"",includeCode:!0,spanish:!1},$scope.status={loading:!1,sent:!1,error:!1},$scope.messageMaxLength=160;var signupPrompt,TEXT_MAX_LENGTH=160,SIGNUP_LINK="https://www.justfix.nyc/signup",updateMessage=function(){var qsObject={};$scope.sms.includeCode&&(qsObject.q=Authentication.user.code),$scope.sms.spanish&&(qsObject.lang="es");var qs=$httpParamSerializer(qsObject),signupLink=qs?SIGNUP_LINK+"?"+qs:SIGNUP_LINK;signupPrompt=$scope.sms.spanish?" Regístrate en: "+signupLink:" Sign up at: "+signupLink,$scope.sms.message=$scope.sms.userMessage+signupPrompt,$scope.length=$scope.sms.message.length,$scope.messageMaxLength=TEXT_MAX_LENGTH-signupPrompt.length},updateUserMessage=function(){$scope.sms.includeCode&&$scope.sms.spanish?$scope.sms.userMessage="Comience a usar JustFix.nyc para enviar fotos e información a "+Authentication.user.firstName+" en "+Authentication.user.organization+".":$scope.sms.includeCode&&!$scope.sms.spanish?$scope.sms.userMessage="Start using JustFix.nyc to send info to "+Authentication.user.firstName+" at "+Authentication.user.organization+"!":!$scope.sms.includeCode&&$scope.sms.spanish?$scope.sms.userMessage="Comience a usar JustFix.nyc para documentar sus problemas de vivienda!":$scope.sms.userMessage="Start using JustFix.nyc to document your issues!"};$scope.$watch("sms.includeCode",function(newVal,oldVal){updateUserMessage(),updateMessage()}),$scope.$watch("sms.spanish",function(newVal,oldVal){updateUserMessage(),updateMessage()}),$scope.$watch("sms.userMessage",function(newVal,oldVal){updateMessage()}),$scope.setLangSpanish=function(yn){$scope.sms.spanish=yn};var timerCountdown=30,setCreationTimer=function(){$timeout(function(){$scope.status.sent||($scope.status.loading=!1,$scope.status.error=!0,Rollbar.warning("Request for the sms took too long to respond"),$scope.errorCode="Request for the sms took too long to respond")},1e3*timerCountdown)};$scope.sendSMS=function(){$scope.sms.userMessage.length>$scope.messageMaxLength?$scope.lengthError=!0:$scope.lengthError=!1,$scope.sms.phone.length?$scope.phoneError=!1:$scope.phoneError=!0,$scope.lengthError||$scope.phoneError?$timeout(function(){$scope.elemHasChanged=!0}):($scope.status.loading=!0,Advocates.sendReferralSMS({},{phone:$scope.sms.phone,message:$scope.sms.message},function(success){setCreationTimer(),$scope.status.loading=!1,$scope.status.sent=!0},function(error){$scope.status.loading=!1,$scope.status.error=!0,Rollbar.error("Error with SMS referral service"),$scope.errorCode=error.data.message}))},$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.done=function(){$modalInstance.close({})}}]),angular.module("advocates").directive("addDetails",["$rootScope","$filter","$sce","$timeout","Activity","Advocates","Problems",function($rootScope,$filter,$sce,$timeout,Activity,Advocates,Problems){return{restrict:"E",templateUrl:"modules/advocates/partials/add-details.client.view.html",scope:{tenant:"="},link:function(scope,element,attrs){scope.problems=[],scope.$watch("tenant",function(tenant){if(tenant){scope.tenant=tenant;for(var i=0;i<scope.tenant.problems.length;i++)scope.problems.push(scope.tenant.problems[i].title)}}),scope.status={expanded:!1,tagging:!1,closeAlert:!1,closeErrorAlert:!0,formSubmitted:!1,completed:!1},scope.newActivity={date:"",title:"modules.activity.other.statusUpdate",key:"statusUpdate",relatedProblems:[],photos:[]},scope.expand=function(event){event.preventDefault(),scope.status.expanded=!0},scope.toggleTagging=function(){scope.status.tagging=!scope.status.tagging},scope.selectProblem=function(problem){if(this.isSelectedProblem(problem)){var i=scope.newActivity.relatedProblems.indexOf(problem);scope.newActivity.relatedProblems.splice(i,1)}else scope.newActivity.relatedProblems.push(problem)},scope.isSelectedProblem=function(problem){return scope.newActivity.relatedProblems.indexOf(problem)!==-1},scope.addPhoto=function(file){file&&(scope.newActivity.photos.push(file),file.lastModifiedDate&&(scope.newActivity.date=file.lastModifiedDate))},scope.closeAlert=function(){scope.status.closeAlert=!0},scope.createActivity=function(isValid){if(scope.status.formSubmitted=!0,isValid){$rootScope.loading=!0,console.time("statusUpdate");var activity=new Activity(scope.newActivity);activity.$saveManagedByID({id:scope.tenant._id},function(response){console.timeEnd("statusUpdate"),$rootScope.loading=!1,scope.status.completed=!0,scope.status.formSubmitted=!1,scope.status.expanded=!1,scope.newActivity={date:"",title:"modules.activity.other.statusUpdate",key:"statusUpdate",relatedProblems:[],photos:[]},angular.extend(scope.tenant,response)},function(errorResponse){$rootScope.loading=!1,scope.error=errorResponse.data.message,scope.status.closeErrorAlert=!1})}}}}}]),angular.module("advocates").filter("toAddress",function(){return function(input,bbls){return bbls[input]}}),angular.module("advocates").factory("AdvocatesResource",["$resource",function($resource){return $resource("api/advocates",{},{validateNewUser:{method:"GET",url:"/api/advocates/validate/new"},sendReferralSMS:{method:"POST",url:"/api/advocates/referrals/sms"}})}]).factory("Advocates",["AdvocatesResource","$q",function(AdvocatesResource,$q){var _this=this;return{query:AdvocatesResource.query,validateNewUser:AdvocatesResource.validateNewUser,sendReferralSMS:AdvocatesResource.sendReferralSMS,setCurrentTenant:function(tenant){_this._currentTenant=tenant},getTenantByCurrentOrId:function(id){var filtered=$q.defer();return _this._currentTenant?filtered.resolve(_this._currentTenant):AdvocatesResource.query(function(tenants){filtered.resolve(tenants.filter(function(t){return t._id===id})[0])}),filtered.promise}}}]),angular.module("core").run(["$rootScope","$state","$location","$window","$timeout","Authentication",function($rootScope,$state,$location,$window,$timeout,Authentication){$rootScope.$on("$locationChangeStart",function(event,newUrl,oldUrl){if($rootScope.clearQueryString)$rootScope.clearQueryString=!1;else if(oldUrl.indexOf("?")>=0){var queryString=oldUrl.split("?")[1];newUrl=$location.$$path+"?"+queryString,$location.url(newUrl)}}),$rootScope.$on("$stateChangeError",function(event,toState,toParams,fromState,fromParams,error){Rollbar.error(error),$state.go("landing")}),$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){toState.user&&(Authentication.user?Authentication.user.roles.indexOf(toState.user)===-1&&$location.path("/not-found"):$location.path("/signin")),!Authentication.user&&toState.data&&toState.data.protected&&$location.path("/signin"),$location.search().status&&($rootScope.expandStatus=!0)}),$rootScope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){$window.scrollTo(0,0),toState.globalStyles?$rootScope.globalStyles=toState.globalStyles:$rootScope.globalStyles="",Authentication.user&&Authentication.user.roles.indexOf("advocate")!==-1&&($rootScope.globalStyles+=" advocate-view")})}]),angular.module("core").config(["$stateProvider","$urlRouterProvider","$provide",function($stateProvider,$urlRouterProvider,$provide){$urlRouterProvider.otherwise("/not-found"),$urlRouterProvider.rule(function($injector,$location){var user=$injector.get("Authentication").user;if("/"===$location.path()){if(!user)return"/signup";switch(user.roles[0]){case"admin":return"/admin";case"advocate":return"/advocate";case"tenant":return"/home";default:return"/home"}}}),$stateProvider.state("landing",{url:"/",data:{disableBack:!0},globalStyles:"landing white-bg"}).state("not-found",{url:"/not-found",templateUrl:"modules/core/views/404.client.view.html",data:{disableBack:!0}}).state("oldLanding",{url:"/espanol",templateUrl:"modules/core/views/landing.client.view.html",onEnter:function(LocaleService,$state){LocaleService.setLocaleByName("es_mx")},data:{disableBack:!0},globalStyles:"landing white-bg"}).state("donate",{url:"/donate",onEnter:function($window){$window.open("https://www.justfix.nyc/donate","_self")}}).state("home",{url:"/home",templateUrl:"modules/core/views/home.client.view.html",data:{protected:!0,disableBack:!0},user:"tenant"}).state("contact",{url:"/contact",templateUrl:"modules/core/views/contact.client.view.html",data:{},globalStyles:"white-bg"})}]),angular.module("core").controller("ContactController",["$rootScope","$scope","Authentication","deviceDetector",function($rootScope,$scope,Authentication,deviceDetector){$scope.authentication=Authentication,$scope.device=deviceDetector}]),angular.module("core").controller("FooterController",["$scope","$window","Authentication",function($scope,$window,Authentication){$scope.authentication=Authentication;var links={actions:{link:"listActions",title:"repeating.listActions",icon:"/modules/core/img/sections/action.svg"},activity:{link:"listActivity",title:"repeating.caseHistory",icon:"/modules/core/img/sections/history.svg"},issues:{link:"updateProblems",title:"repeating.issueChecklist",icon:"/modules/core/img/sections/issues.svg"},profile:{link:"settings.profile",title:"repeating.profile",icon:"/modules/core/img/sections/profile.svg"},help:{link:"findHelp",title:"repeating.findHelp",icon:"/modules/core/img/sections/help.svg"},kyr:{link:"kyr",title:"repeating.kyr",icon:"/modules/core/img/sections/kyr.svg"}};$scope.footerLinks=[],$scope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){switch(toState.name){case"kyr":$scope.footerLinks=[links.actions,links.help];break;case"kyrDetail":$scope.footerLinks=[links.actions,links.help];break;case"findHelp":case"listActions":$scope.footerLinks=[links.activity,links.kyr];break;case"listActivity":$scope.footerLinks=[links.issues,links.help];break;case"updateProblems":$scope.footerLinks=[links.actions,links.activity];break;default:$scope.footerLinks=[]}})}]),angular.module("core").controller("HeaderController",["$rootScope","$state","$scope","$window","Authentication",function($rootScope,$state,$scope,$window,Authentication){$scope.authentication=Authentication,$scope.window=$window,$rootScope.$on("$stateChangeSucess",function(event,toState,toParams,fromState,fromParams){Authentication.user?($rootScope.showBack=!0,toState.data&&toState.data.disableBack&&($rootScope.showBack=!1)):$rootScope.showBack=!1})}]),angular.module("core").controller("HomeController",["$rootScope","$scope","$timeout","Authentication","Users","deviceDetector",function($rootScope,$scope,$timeout,Authentication,Users,deviceDetector){$scope.authentication=Authentication,$scope.device=deviceDetector,$scope.$watch("authentication.user",function(){$scope.authentication.user.currentAcuityEventId&&($scope.appt=Users.getScheduledEventInfo())}),$rootScope.closeDashboardAlert=!1}]),angular.module("core").controller("LandingController",["$scope","Authentication","deviceDetector",function($scope,Authentication,deviceDetector){$scope.authentication=Authentication,$scope.device=deviceDetector}]),angular.module("core").directive("bottomOnClick",["$document","$timeout",function($document,$timeout){return{controller:function($parse,$element,$attrs,$scope){var parent=$attrs.bottomOnClick,parentElm=document.getElementById(parent);$element.bind("click",function(e){$timeout(function(){parentElm.scrollTop=parentElm.scrollHeight},0)})}}}]),angular.module("core").directive("emailMessage",["deviceDetector","Authentication","Messages",function(deviceDetector,Authentication,Messages){return{restrict:"A",scope:!1,link:function(scope,element,attrs){var msg=Messages.getShareMessage("share"),href="mailto:";attrs.email&&attrs.email.length&&(href+=attrs.email),href=encodeURI(href+"?subject="+Authentication.user.fullName+" - JustFix.nyc Case History&body="+msg),attrs.$set("href",href)}}}]),angular.module("core").directive("filesModel",function(){return{controller:function($parse,$element,$attrs,$scope){var exp=$parse($attrs.filesModel);$element.on("change",function(){exp.assign($scope,this.files),$scope.$apply()})}}}),angular.module("core").directive("focusOnTouch",function(){return{restrict:"A",link:function(scope,element,attr){element.on("touchstart",function(e){element.focus(),e.preventDefault(),e.stopPropagation()})}}}).directive("stopEvent",function(){return{restrict:"A",link:function(scope,element,attr){element.on(attr.stopEvent,function(e){e.stopPropagation()})}}}),angular.module("core").directive("fullBg",function($window){return function(scope,element,attrs){function getWidth(){return self.innerHeight?self.innerWidth:document.documentElement&&document.documentElement.clientHeight?document.documentElement.clientWidth:document.body?document.body.clientWidth:void 0}$window.addEventListener("resize",function(){element.css("width",getWidth()+"px")}),element.css("width",getWidth()+"px")}}),angular.module("core").directive("gaEvent",["deviceDetector","$window",function(deviceDetector,$window){return{restrict:"A",scope:!1,link:function(scope,element,attrs){var a=attrs.gaEvent.split(","),cat=a[0],action=a[1];if(3==a.length)var label=a[2];else var label="";element.on("click",function(event){$window.ga("send","event",cat,action,label)})}}}]),angular.module("core").directive("goToTop",function($document){return{restrict:"A",link:function(scope,elm,attrs){elm.bind("click",function(){function scrollToTop(element,to,duration){if(!(duration<0)){var difference=to-element.scrollTop,perTick=difference/duration*10;setTimeout(function(){element.scrollTop=element.scrollTop+perTick,scrollToTop(element,to,duration-10)},10)}}scrollToTop($document[0].body,0,200)})}}}),angular.module("core").directive("imageOrient",["$timeout",function($timeout){return{restrict:"A",link:function(scope,element,attr){attr.$observe("imageOrient",function(value){if(value){var width=element[0].naturalWidth||element[0].width,height=element[0].naturalHeight||element[0].height;console.log(width,height),console.log(element[0]),value=parseInt(value,10),value=6,exifOrient(element[0],value,function(err,canvas){err?console.error(err):(console.log(canvas),element[0].src=canvas.toDataURL())})}})}}}]),angular.module("core").directive("inheritHeight",["$window","$timeout","deviceDetector",function($window,$timeout,deviceDetector){return{restrict:"A",link:function(scope,elm,attrs){scope.$watch("status.state",function(newV,oldV){$timeout(function(){elm.css("height",elm[0].querySelector(".letter-step.ng-enter").offsetHeight+"px")})})}}}]),angular.module("core").directive("inputFocusFn",["$timeout",function($timeout){return{restrict:"A",link:function(scope,element,attr){scope.$parent[attr.inputFocusFn]=function(){$timeout(function(){element[0].focus()})}}}}]),angular.module("core").directive("jumpTo",["$document",function($document){return{controller:function($parse,$element,$attrs,$scope){var id=$attrs.jumpTo,duration=1e3,easing=function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},offset=0,someElement=angular.element(document.getElementById(id));$element.bind("click",function(e){$document.scrollToElement(someElement,offset,duration,easing)})}}}]),angular.module("core").directive("languageSelect",function(LocaleService,$window,$location){return{restrict:"A",replace:!0,templateUrl:"modules/core/partials/language-select.client.view.html",controller:function($scope){$scope.currentLocaleDisplayName=LocaleService.getLocaleDisplayName(),$scope.localesDisplayNames=LocaleService.getLocalesDisplayNames(),$scope.visible=$scope.localesDisplayNames&&$scope.localesDisplayNames.length>1,$scope.changeLanguage=function(locale){LocaleService.setLocaleByDisplayName(locale)}}}}),angular.module("core").directive("languageToggle",function(LocaleService,$window,$location){return{restrict:"A",replace:!0,templateUrl:"modules/core/partials/language-toggle.client.view.html",controller:function($scope){var getLocaleName=function(){$scope.currentLocaleDisplayName=LocaleService.getLocaleDisplayName(),"Español"==$scope.currentLocaleDisplayName?$scope.newLocaleName="English":$scope.newLocaleName="Español"};getLocaleName(),$scope.changeLanguage=function(locale){LocaleService.setLocaleByDisplayName(locale),getLocaleName()}}}}),angular.module("core").directive("loading",function($document){return{restrict:"E",templateUrl:"modules/core/partials/loading.client.view.html",link:function(scope,elm,attrs){}}}),angular.module("core").directive("mobileDatePlaceholder",["deviceDetector",function(deviceDetector){return{restrict:"A",scope:!1,link:function(scope,elm,attrs){(deviceDetector.isMobile()||deviceDetector.isTablet())&&elm.addClass("date-mobile"),scope.$watch(attrs.ngModel,function(v){v&&elm.removeClass("date-mobile")})}}}]),angular.module("core").directive("phoneInput",function($filter,$browser){return{require:"ngModel",link:function($scope,$element,$attrs,ngModelCtrl){var listener=function(){var value=$element.val().replace(/[^0-9]/g,"");$element.val($filter("tel")(value,!1)),value.length<10||value.search(/[^a-z]/g)?ngModelCtrl.$setValidity("",!1):ngModelCtrl.$setValidity("",!0)};ngModelCtrl.$parsers.push(function(viewValue){return viewValue.replace(/[^0-9]/g,"").slice(0,10)}),ngModelCtrl.$render=function(){$element.val($filter("tel")(ngModelCtrl.$viewValue,!1))};var unbindAfterInit=$scope.$watch(function(){return ngModelCtrl.$modelValue},function(value){$element.val($filter("tel")(ngModelCtrl.$viewValue,!1)),unbindAfterInit()});$element.bind("change",listener),$element.bind("keydown",function(event){var key=event.keyCode;91===key||15<key&&key<19||37<=key&&key<=40||$browser.defer(listener)}),$element.bind("paste cut",function(){$browser.defer(listener)})}}}),angular.module("core").directive("printButton",["deviceDetector","$window","$timeout","$rootScope",function(deviceDetector,$window,$timeout,$rootScope){return{restrict:"A",scope:{userId:"="},link:function(scope,element,attrs){var printPg;deviceDetector.isDesktop()?(element.addClass("print-button"),element.addClass("disabled")):element.css("display","none");var checkLoaded=function(){var printView=printPg.contentWindow.angular.element(printPg.contentWindow.document.querySelector("#print-view"));if(!printView.scope())return $timeout(function(){checkLoaded()},500);var printableLoaded=printView.scope().printable;return printableLoaded?(element.removeClass("disabled"),void element.on("click",function(event){window.frames["print-frame"].print()})):$timeout(function(){checkLoaded()},500)},iframe=document.getElementById("print-frame"),queryKey="";scope.userId&&(queryKey=scope.userId),iframe?(printPg=iframe,printPg.src="/print/"+queryKey,printPg.contentWindow.location.reload()):(printPg=document.createElement("iframe"),printPg.src="/print/"+queryKey,printPg.width=700,printPg.height=0,printPg.setAttribute("id","print-frame"),printPg.name="print-frame",document.body.appendChild(printPg)),printPg.onload=function(){checkLoaded()}}}}]),angular.module("core").directive("propagateEvent",function(){return{restrict:"A",link:function(scope,element,attr){element.on("click",function(e){console.log("propagate event")})}}}),angular.module("core").directive("smsMessage",["deviceDetector","Authentication","Messages",function(deviceDetector,Authentication,Messages){return{restrict:"A",scope:!1,link:function(scope,element,attrs){var getIOSversion=function(){var v=navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/);return[parseInt(v[1],10),parseInt(v[2],10),parseInt(v[3]||0,10)]},isGtIOS7=function(){return"ios"===deviceDetector.os&&getIOSversion()[0]>7};element.on("click",function(e){var href="sms:",type=attrs.type,msg=Messages.getShareMessage(type);attrs.phone&&attrs.phone.length&&(href+=attrs.phone),"ios"===deviceDetector.os?(href+=isGtIOS7()?"&":";",href=href+"body="+msg,console.log("href",href),attrs.$set("href",href)):"android"===deviceDetector.os?(href=href+"?body="+msg,attrs.$set("href",href)):(href=href+"?body="+msg,console.log(href),console.log("If you were using a phone, the message would be: \n\n"+msg))})}}}]),angular.module("core").directive("stopEvent",function(){return{restrict:"A",link:function(scope,element,attr){element.on(attr.stopEvent,function(e){e.stopPropagation()})}}}),angular.module("core").directive("twitterFollow",["$timeout",function($timeout){return{link:function(scope,element,attr){$timeout(function(){twttr.widgets.createFollowButton("JustFixNYC",element[0],{showScreenName:!1,showCount:!1})})}}}]),angular.module("core").directive("variableHeight",["$document","$timeout",function($document,$timeout){return{controller:function($parse,$element,$attrs,$scope){var parent=$attrs.variableHeight,parentElm=document.getElementById(parent);$scope.$watch(function(){angular.element(parentElm).css("height",$element[0].offsetHeight+"px")}),$scope.$parent.$watch("elemHasChanged",function(newVal,oldVal){newVal&&angular.element(parentElm).css("height",$element[0].offsetHeight+"px")})}}}]),angular.module("core").directive("windowHeight",["$window","deviceDetector",function($window,deviceDetector){return function(scope,element,attrs){function getHeight(){return self.innerWidth?self.innerHeight:document.documentElement&&document.documentElement.clientWidth?document.documentElement.clientHeight:document.body?document.body.clientHeight:void 0}deviceDetector.isMobile()||$window.addEventListener("resize",function(){element.css("height",getHeight()+"px")}),deviceDetector.isMobile()&&"safari"===deviceDetector.browser?element.css("height",getHeight()+60+"px"):element.css("height",getHeight()+"px")}}]),angular.module("core").filter("firstname",function(){return function(input){return input?input.split(" ")[0]:input}}),angular.module("core").filter("tel",function(){return function(tel){if(!tel)return"";var value=tel.toString().trim().replace(/^\+/,"");if(","===value.charAt(10)){var ext=value.split(",")[1];value=value.split(",")[0]}if(value.match(/[^0-9]/))return tel;var city,number;switch(value.length){case 1:case 2:case 3:city=value;break;default:city=value.slice(0,3),number=value.slice(3)}if(number){number=number.length>3?number.slice(0,3)+"-"+number.slice(3,7):number;var phone="("+city+") "+number;return ext?(phone+" ext. "+ext).trim():phone.trim()}return"("+city}}),angular.module("core").filter("titlecase",function(){return function(input){var smallWords=/^(a|an|and|as|at|but|by|en|for|if|in|nor|of|on|or|per|the|to|vs?\.?|via)$/i;return input=input.toLowerCase(),input.replace(/[A-Za-z0-9\u00C0-\u00FF]+[^\s-]*/g,function(match,index,title){return index>0&&index+match.length!==title.length&&match.search(smallWords)>-1&&":"!==title.charAt(index-2)&&("-"!==title.charAt(index+match.length)||"-"===title.charAt(index-1))&&title.charAt(index-1).search(/[^\s-]/)<0?match.toLowerCase():match.substr(1).search(/[A-Z]|\../)>-1?match:match.charAt(0).toUpperCase()+match.substr(1)})}}),angular.module("core").filter("trustAs",["$sce",function($sce){return function(input,type){return"string"==typeof input?$sce.trustAs(type||"html",input):""}}]),angular.module("core").filter("trustTranslate",["$sce","$filter","Authentication",function($sce,$filter,Authentication){var user=Authentication.user,translatedText=$filter("translate");return function(val){var returnedTranslation=translatedText(val);return returnedTranslation.indexOf("user.borough")>-1&&(returnedTranslation=returnedTranslation.replace("user.borough",user.borough)),$sce.trustAsHtml(returnedTranslation)}}]),angular.module("core").service("LocaleService",function($translate,LOCALES,$rootScope,tmhDynamicLocale,$location){var localesObj=LOCALES.locales,_LOCALES=Object.keys(localesObj);_LOCALES&&0!==_LOCALES.length||console.error("There are no _LOCALES provided");var _LOCALES_DISPLAY_NAMES=[];_LOCALES.forEach(function(locale){_LOCALES_DISPLAY_NAMES.push(localesObj[locale])});var currentLocale=$translate.proposedLanguage(),checkLocaleIsValid=function(locale){return _LOCALES.indexOf(locale)!==-1},setLocale=function(locale){return checkLocaleIsValid(locale)?(currentLocale=locale,void $translate.use(locale)):void console.error('Locale name "'+locale+'" is invalid')};return $rootScope.$on("$translateChangeSuccess",function(event,data){tmhDynamicLocale.set(data.language.toLowerCase().replace(/_/g,"-"))}),{getLocaleDisplayName:function(){return localesObj[currentLocale]},setLocaleByDisplayName:function(localeDisplayName){setLocale(_LOCALES[_LOCALES_DISPLAY_NAMES.indexOf(localeDisplayName)])},setLocaleByName:function(localeName){setLocale(localeName)},checkIfLocaleIsValid:function(locale){return checkLocaleIsValid(locale)},getLocalesDisplayNames:function(){return _LOCALES_DISPLAY_NAMES}}}),angular.module("core").service("Menus",[function(){this.defaultRoles=["*"],this.menus={};var shouldRender=function(user){if(!user)return this.isPublic;if(~this.roles.indexOf("*"))return!0;for(var userRoleIndex in user.roles)for(var roleIndex in this.roles)if(this.roles[roleIndex]===user.roles[userRoleIndex])return!0;return!1};this.validateMenuExistance=function(menuId){if(menuId&&menuId.length){if(this.menus[menuId])return!0;throw new Error("Menu does not exists")}throw new Error("MenuId was not provided")},this.getMenu=function(menuId){return this.validateMenuExistance(menuId),this.menus[menuId]},this.addMenu=function(menuId,isPublic,roles){return this.menus[menuId]={isPublic:isPublic||!1,roles:roles||this.defaultRoles,items:[],shouldRender:shouldRender},this.menus[menuId]},this.removeMenu=function(menuId){this.validateMenuExistance(menuId),delete this.menus[menuId]},this.addMenuItem=function(menuId,menuItemTitle,menuItemURL,menuItemType,menuItemUIRoute,isPublic,roles,position){return this.validateMenuExistance(menuId),this.menus[menuId].items.push({title:menuItemTitle,link:menuItemURL,menuItemType:menuItemType||"item",menuItemClass:menuItemType,uiRoute:menuItemUIRoute||"/"+menuItemURL,isPublic:null===isPublic||"undefined"==typeof isPublic?this.menus[menuId].isPublic:isPublic,roles:null===roles||"undefined"==typeof roles?this.menus[menuId].roles:roles,position:position||0,items:[],shouldRender:shouldRender}),this.menus[menuId]},this.addSubMenuItem=function(menuId,rootMenuItemURL,menuItemTitle,menuItemURL,menuItemUIRoute,isPublic,roles,position){this.validateMenuExistance(menuId);
for(var itemIndex in this.menus[menuId].items)this.menus[menuId].items[itemIndex].link===rootMenuItemURL&&this.menus[menuId].items[itemIndex].items.push({title:menuItemTitle,link:menuItemURL,uiRoute:menuItemUIRoute||"/"+menuItemURL,isPublic:null===isPublic||"undefined"==typeof isPublic?this.menus[menuId].items[itemIndex].isPublic:isPublic,roles:null===roles||"undefined"==typeof roles?this.menus[menuId].items[itemIndex].roles:roles,position:position||0,shouldRender:shouldRender});return this.menus[menuId]},this.removeMenuItem=function(menuId,menuItemURL){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)this.menus[menuId].items[itemIndex].link===menuItemURL&&this.menus[menuId].items.splice(itemIndex,1);return this.menus[menuId]},this.removeSubMenuItem=function(menuId,submenuItemURL){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)for(var subitemIndex in this.menus[menuId].items[itemIndex].items)this.menus[menuId].items[itemIndex].items[subitemIndex].link===submenuItemURL&&this.menus[menuId].items[itemIndex].items.splice(subitemIndex,1);return this.menus[menuId]},this.addMenu("topbar")}]),angular.module("findhelp").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$stateProvider.state("findHelp",{url:"/find-help",templateUrl:"modules/findhelp/views/find-help.client.view.html",data:{protected:!0},user:"tenant"})}]),angular.module("findhelp").controller("FindHelpController",["$scope","$window","Authentication","CartoDB","Hotlines",function($scope,$window,Authentication,CartoDB,Hotlines){$scope.user=Authentication.user,$scope.hotlines=[],$scope.update=function(type){var lat=$scope.user.geo.lat,lng=$scope.user.geo.lon;$scope.updateCartoMap(lat,lng,type),"hotlines"!=type||$scope.hotlines.length?"hotlines"==type&&$scope.hotlines.length?$scope.resources=$scope.hotlines:$scope.updateCartoList(lat,lng,type):Hotlines.getLocalFile().then(function(data){$scope.resources=$scope.hotlines=data},function(err){console.log("errors:"+errors)})},$scope.init=function(){$scope.update("community")},$scope.updateCartoList=function(lat,lng,orgType){CartoDB.queryByLatLng(lat,lng,orgType).done(function(data){0==data.rows.length,$scope.resources=data.rows,$scope.$apply()}).error(function(errors){Rollbar.error("Carto List Error",errors),console.log("errors:"+errors)})}}]),angular.module("findhelp").directive("cartoMap",["$rootScope","CartoDB",function($rootScope,CartoDB){return{restrict:"E",template:'<div id="map" class="panel"></div>',scope:!1,link:function(scope,element,attrs){var map=L.map("map",{scrollWheelZoom:!1,center:[40.7127,-73.96270751953125],zoom:10});L.Icon.Default.imagePath="/modules/core/img/leaflet";L.mapboxGL({accessToken:"pk.eyJ1IjoiZGFuLWthc3MiLCJhIjoiY2lsZTFxemtxMGVpdnVoa3BqcjI3d3Q1cCJ9.IESJdCy8fmykXbb626NVEw",style:"mapbox://styles/dan-kass/cilljc5nu004d9vkngyozkhzb",attributionControl:!0}).addTo(map);map.attributionControl.removeFrom(map),map.attributionControl.setPrefix("");var credits=L.control.attribution().addTo(map);credits.addAttribution("© <a href='https://www.mapbox.com/map-feedback/'>Mapbox</a> © <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a>");var mainSublayer,userMarker,layerSource={user_name:"dan-kass",type:"cartodb",sublayers:[{sql:"SELECT * FROM nyc_cbos_locations",cartocss:"#nyc_cbos_locations{marker-fill-opacity:.9;marker-line-color:#FFF;marker-line-width:1;marker-line-opacity:1;marker-placement:point;marker-type:ellipse;marker-width:10;marker-fill:#F60;marker-allow-overlap:true}"}]},cartoMapOptions={https:!0};cartodb.createLayer(map,layerSource,cartoMapOptions).addTo(map).done(function(layer){mainSublayer=layer.getSubLayer(0),scope.init()}).error(function(err){Rollbar.error("Carto Map Error",err),console.log("An error occurred: "+err)}),scope.updateCartoMap=function(lat,lng,type){var query,cartocss;"legal"==type||"community"==type?(query="SELECT *, row_number() OVER (ORDER BY dist) as rownum FROM ( SELECT loc.cartodb_id, loc.the_geom, loc.the_geom_webmercator, round( (ST_Distance( ST_GeomFromText('Point("+lng+" "+lat+")', 4326)::geography, loc.the_geom::geography ) / 1609)::numeric, 1 ) AS dist FROM nyc_cbos_locations AS loc, nyc_cbos_service_areas AS sa WHERE ST_Intersects( ST_GeomFromText( 'Point("+lng+" "+lat+")', 4326 ), sa.the_geom ) AND loc.organization = sa.organization AND loc.org_type IN ('"+type+"') ORDER BY dist ASC ) T LIMIT 5",cartocss="#nyc_cbos_locations{marker-fill-opacity:.9;marker-line-color:#FFF;marker-line-width:1;marker-line-opacity:1;marker-placement:point;marker-type:ellipse;marker-width:10;marker-fill:#F60;marker-allow-overlap:true}#nyc_cbos_locations::labels{text-name:[rownum];text-face-name:'DejaVu Sans Book';text-size:20;text-label-position-tolerance:10;text-fill:#000;text-halo-fill:#FFF;text-halo-radius:2;text-dy:-10;text-allow-overlap:true;text-placement:point;text-placement-type:simple}"):(query="SELECT * FROM nyc_cbos_locations",cartocss="#nyc_cbos_locations{marker-fill-opacity:.9;marker-line-color:#FFF;marker-line-width:1;marker-line-opacity:1;marker-placement:point;marker-type:ellipse;marker-width:10;marker-fill:#F60;marker-allow-overlap:true}"),userMarker&&map.removeLayer(userMarker),userMarker=L.marker([lat,lng]),userMarker.addTo(map),mainSublayer.set({sql:query,cartocss:cartocss}),CartoDB.getSQL().getBounds(query).done(function(bounds){bounds.push([lat,lng]),map.fitBounds(bounds,{padding:[10,10]})})}}}}]),angular.module("findhelp").service("CartoDB",[function(){var cartoSQL=new cartodb.SQL({user:"dan-kass"});return{queryByLatLng:function(lat,lng,type){var query="SELECT *, row_number() OVER (ORDER BY dist) as rownum FROM ( SELECT loc.organization, loc.contact_information, loc.address, loc.services, round( (ST_Distance( ST_GeomFromText('Point("+lng+" "+lat+")', 4326)::geography, loc.the_geom::geography ) / 1609)::numeric, 1 ) AS dist FROM nyc_cbos_locations AS loc, nyc_cbos_service_areas AS sa WHERE ST_Intersects( ST_GeomFromText( 'Point("+lng+" "+lat+")', 4326 ), sa.the_geom ) AND loc.organization = sa.organization AND loc.org_type IN ('"+type+"') ORDER BY dist ASC ) T LIMIT 5";return cartoSQL.execute(query)},getSQL:function(){return cartoSQL}}}]),angular.module("onboarding").factory("Hotlines",["$http","$q",function($http,$q){var requestLocalFile=function(){var deferred=$q.defer();return $http.get("data/hotlines.json").then(function(response){deferred.resolve(response.data)},function(err){deferred.reject(err)}),deferred.promise};return{getLocalFile:function(){return requestLocalFile()}}}]),angular.module("kyr").run(["$rootScope","$state","$window","$location",function($rootScope,$state,$window,$location){$rootScope.$on("$stateChangeSuccess",function(){$rootScope.noMargin=$state.current.noMargin,$state.current.localHistory?$rootScope.showKyrBackBtn=!0:$rootScope.showKyrBackBtn=!1})}]),function(){function routeConfig($stateProvider,$urlRouterProvider){$stateProvider.state("kyr",{url:"/kyr",templateUrl:"modules/kyr/views/kyr.client.view.html",controller:"KyrController",noMargin:!0,user:"tenant"}).state("kyrDetail",{url:"/kyr/:kyrId",templateUrl:"modules/kyr/views/kyr-detail.client.view.html",controller:"KyrDetailController",noMargin:!0,data:{disableBack:!0},localHistory:!0,globalStyles:"white-bg",user:"tenant"})}angular.module("kyr").config(routeConfig),routeConfig.$inject=["$stateProvider","$urlRouterProvider"]}(),angular.module("kyr").controller("KyrDetailController",["$scope","$stateParams","kyrService","$sce",function($scope,$stateParams,kyrService,$sce){var queryThis=$stateParams.kyrId-1;$scope.expand=!1,$scope.canExpand=!1,kyrService.single(queryThis).then(function(data){if($scope.kyr=data,$scope.content=$sce.trustAsHtml(data.content),data.readMore)return $scope.canExpand=!0})}]),angular.module("kyr").controller("KyrController",["kyrService","$scope","Pdf","$translate",function(kyrService,$scope,Pdf,$translate){$scope.lang=$translate.use();$scope.kyrResponse,"es_mx"===$scope.lang?(console.log("true"),kyrService.fetchEs().then(function(data){$scope.kyrResponse=data},function(err){console.log(err)})):kyrService.fetch().then(function(data){$scope.kyrResponse=data},function(err){console.log(err)})}]),angular.module("kyr").filter("newlines",["$sce",function($sce){return function(text){var treatedText=text.replace(/\\n/g,"<br/>");return $sce.trustAsHtml(treatedText)}}]),angular.module("kyr").factory("kyrService",["$resource","$http","$q",function($resource,$http,$q){return this.fetch=function(){var deferred=$q.defer();return $http.get("/data/kyr.json").then(function(data){var finalData=data.data;deferred.resolve(finalData)},function(err){console.log(err),deferred.reject(err)}),deferred.promise},this.fetchEs=function(){var deferred=$q.defer();return $http.get("/data/kyr_es.json").then(function(data){var finalData=data.data;deferred.resolve(finalData)},function(err){console.log(err),deferred.reject(err)}),deferred.promise},this.single=function(id){var deferred=$q.defer();return $http.get("/data/kyr.json").then(function(data){var finalKyr=data.data[id],length=data.data.length;id===length-1?finalKyr.next=!1:finalKyr.next=id+2,id<=0?finalKyr.prev=!1:finalKyr.prev=id,void 0!==finalKyr?deferred.resolve(finalKyr):deferred.reject("This KYR does not exist")},function(err){deferred.reject(err)}),deferred.promise},this}]),angular.module("onboarding").run(["$rootScope","$location","Authentication","Users","$window",function($rootScope,$location,Authentication,Users,$window){$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){toState.onboarding&&Authentication.user&&$location.path("/"),"onboarding.scheduleNew"===fromState.name&&Users.me(),"onboarding.referral"!==toState.name||$location.search().q||$location.path("/")})}]),angular.module("onboarding").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.when("/signup","/onboarding/get-started"),$stateProvider.state("onboarding",{url:"/onboarding",templateUrl:"modules/onboarding/views/onboarding.client.view.html",controller:"OnboardingController",abstract:!0,resolve:{advocateData:["$location","$rootScope","$q","Advocates",function($location,$rootScope,$q,Advocates){var deferred=$q.defer();return $location.search().q?Advocates.validateNewUser({code:$location.search().q},function(success){success.advocate?deferred.resolve(success):($rootScope.clearQueryString=!0,$location.search("q",null),deferred.reject("Not a valid advocate code."))},function(error){$rootScope.clearQueryString=!0,$location.search("q",null),deferred.reject(error)}):deferred.resolve({}),deferred.promise}]}}).state("onboarding.orientation",{url:"/get-started",templateUrl:"modules/onboarding/partials/onboarding-orientation.client.view.html",onboarding:!0,globalStyles:"white-bg",data:{disableBack:!0}}).state("onboarding.success",{url:"/success",templateUrl:"modules/onboarding/partials/onboarding-success.client.view.html",onboarding:!0,globalStyles:"white-bg",data:{disableBack:!0}}).state("onboarding.problems",{url:"/checklist",templateUrl:"modules/onboarding/partials/onboarding-problems.client.view.html",onboarding:!0}).state("onboarding.details",{url:"/personal",templateUrl:"modules/onboarding/partials/onboarding-details.client.view.html",onboarding:!0}).state("onboarding.schedulePrompt",{url:"/consultation",templateUrl:"modules/onboarding/partials/onboarding-schedule-prompt.client.view.html",data:{disableBack:!0}}).state("onboarding.scheduleNew",{url:"/consultation/new",templateUrl:"modules/onboarding/partials/onboarding-schedule.client.view.html"}).state("onboarding.referral",{url:"/referral",templateUrl:"modules/onboarding/partials/onboarding-referral.client.view.html",onboarding:!0,data:{disableBack:!0}})}]),angular.module("onboarding").controller("OnboardingController",["$rootScope","$scope","$location","$timeout","$filter","Users","Authentication","Advocates","$http","$modal","advocateData",function($rootScope,$scope,$location,$timeout,$filter,Users,Authentication,Advocates,$http,$modal,advocateData){$scope.authentication=Authentication,$scope.newUser={},$scope.newUser.problems=[],$scope.newUser.sharing={enabled:!1},$scope.accessCode={valid:!1},"undefined"!=typeof DEBUG&&1==DEBUG&&($scope.newUser={firstName:"Dan",lastName:"Stevenson",password:"password",borough:"Brooklyn",address:"654 Park Place",unit:"1RF",phone:(Math.floor(9999999999*Math.random())+1111111111).toString(),problems:[],sharing:{enabled:!1}},$scope.accessCode={value:"",valid:!1}),$scope.hasAdvocateCode=!1,$scope.openAdvocateCodeForm=function($event){$scope.hasAdvocateCode=!0,$scope.focusOnCodeEntry()},$scope.closeAdvocateCodeForm=function($event){$event.stopPropagation(),$event.preventDefault(),$scope.hasAdvocateCode=!1};var onAdvocateSuccess=function(advocateData){$scope.accessCode.valid=$rootScope.validated=!0,$scope.accessCode.valueEntered=$scope.accessCode.value,$scope.newUser.advocate=advocateData.advocate,$scope.newUser.advocateRole=advocateData.advocateRole,$scope.referral=advocateData.referral,$scope.newUser.sharing.enabled=!0};advocateData&&onAdvocateSuccess(advocateData),$scope.validateCode=function(){$scope.accessCode.valueEntered&&$scope.accessCode.valueEntered===$scope.accessCode.value?$scope.accessCode.valueEntered==$scope.accessCode.value&&($scope.accessCode.valid=!0,$location.path("/onboarding/success"),$scope.codeError=!1,$scope.codeWrong=!1):Advocates.validateNewUser({code:$scope.accessCode.value},function(success){success.advocate?(onAdvocateSuccess(success),$location.path("/onboarding/success"),$scope.codeError=!1,$scope.codeWrong=!1):($scope.codeError=!1,$scope.codeWrong=!0)},function(error){$scope.codeErrorMessage=error.data.message,$scope.codeError=!0,$scope.codeWrong=!1})},$scope.cancelAccessCode=function(){$scope.accessCode.valid=!1,$location.path("/onboarding/get-started")},$scope.additionalInfo=function(){$modal.open({animation:"true",templateUrl:"modules/onboarding/partials/additional-info.client.view.html"})},$scope.userError=!1,$scope.loaded=!1,$scope.createAndNext=function(isValid){"undefined"!=typeof DEBUG&&1==DEBUG&&console.log("create account pre save",$scope.newUser),isValid?($scope.newUser.firstName=$filter("titlecase")($scope.newUser.firstName),$scope.newUser.lastName=$filter("titlecase")($scope.newUser.lastName),$scope.newUser.address=$filter("titlecase")($scope.newUser.address),$scope.userError=!1,$scope.error=void 0,$rootScope.loading=!0,$http.post("/api/tenants/signup",$scope.newUser).success(function(response){$scope.authentication.user=response,"undefined"!=typeof DEBUG&&1==DEBUG&&console.log("create account post save",response),$rootScope.loading=!1,$rootScope.takeActionAlert=!0,$rootScope.validated?$location.path("/home"):$location.path("/onboarding/consultation")}).error(function(err){$timeout(function(){$rootScope.loading=!1,$scope.error=err},1e3)})):$scope.userError=!0}}]),angular.module("onboarding").directive("pwCheck",[function(){return{require:"ngModel",link:function(scope,elem,attrs,ctrl){var firstPassword=attrs.pwCheck;elem.on("keyup",function(){scope.$apply(function(){var v=elem.val()===document.getElementById(firstPassword).value;ctrl.$setValidity("pwmatch",v)})})}}}]),angular.module("onboarding").directive("scheduler",["$sce","$location","Authentication","Users",function($sce,$location,Authentication,Users){return{templateUrl:"modules/onboarding/partials/scheduler.client.view.html",restrict:"E",link:function(scope,element,attrs){scope.user=Authentication.user,scope.trustSrc=function(src){return $sce.trustAsResourceUrl(src)},scope.hasScheduled=!1;var currentLocation=$location.protocol()+"://"+$location.host()+(80!==$location.port()&&443!==$location.port()?":"+$location.port():"");scope.acuity="https://app.acuityscheduling.com/schedule.php?owner=13287615",scope.user&&(scope.acuity+="&firstName="+scope.user.firstName,scope.acuity+="&lastName="+scope.user.lastName,scope.acuity+="&email=support@justfix.nyc",scope.acuity+="&phone="+scope.user.phone,scope.acuity+="&field:2631340="+currentLocation+"/share/"+scope.user.sharing.key),window.addEventListener("message",function(e){if(e.data&&"string"==typeof e.data)if("https://app.acuityscheduling.com"===e.origin&&e.data.indexOf("sizing")>-1){var height=parseInt(e.data.split(":")[1],10);height>0&&element.find("iframe").attr("height",height+"px")}else if("https://sandbox.acuityinnovation.com"===e.origin&&e.data.indexOf("custombooking")>-1){var bookingID=e.data.split(":")[1];scope.hasScheduled=!0,scope.$apply(),console.log("scheduled",bookingID)}})}}}]),angular.module("onboarding").directive("selectionList",function(){return{templateUrl:"modules/onboarding/partials/selection-list.client.view.html",restrict:"E",link:function(scope,element,attrs){for(var aTags=element.find("a"),wrappedTags=[],activateThis=function(){this.on("click",function(e){for(var thisWrapped=angular.element(this),i=0;i<wrappedTags.length;i++)wrappedTags[i].removeClass("active");thisWrapped.addClass("active"),scope.process=this.getAttribute("process")})},i=0;i<aTags.length;i++){var elm=angular.element(aTags[i]);activateThis.call(elm),wrappedTags.push(elm)}}}}),angular.module("problems").run(["$rootScope","$state","$window","Authentication","Users","Problems",function($rootScope,$state,$window,Authentication,Users,Problems){}]),angular.module("problems").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$stateProvider.state("updateProblems",{url:"/checklist",templateUrl:"modules/problems/views/update-problems.client.view.html",user:"tenant"})}]),angular.module("problems").controller("ModalProblemController",["$scope","Problems","$modalInstance","issues","userProblem",function($scope,problems,$modalInstance,issues,userProblem){$scope.issues=issues,$scope.userProblem=userProblem;var userIssuesClone=$scope.userProblem.issues.slice(0);$scope.isSelected=function(issue){return $scope.userProblem.issues.containsByKey(issue.key)},$scope.select=function(issue){$scope.isSelected(issue)?$scope.userProblem.issues.removeByKey(issue.key):$scope.userProblem.issues.push(issue)},$scope.save=function(event){$scope.newOther&&$scope.newOther.key.length&&$scope.addOther(event),$modalInstance.close()},$scope.cancel=function(){$scope.userProblem.issues=userIssuesClone,$modalInstance.dismiss()}}]),angular.module("problems").controller("ProblemsController",["$rootScope","$scope","$state","Authentication","Users","ProblemsResource","Problems",function($rootScope,$scope,$state,Authentication,Users,ProblemsResource,Problems){$scope.user=Authentication.user,$scope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams,options){if($scope.hasChangedProblems&&!toState.updated){event.preventDefault(),toState.updated=!0,$rootScope.loading=!0;var user=new ProblemsResource(Authentication.user);user.$updateChecklist(function(response){$rootScope.loading=!1,$rootScope.dashboardSuccess=!0,$state.go(toState)},function(response){$rootScope.loading=!1,$rootScope.dashboardError=!0,$state.go(toState)})}else toState.updated&&(toState.updated=!1)})}]),angular.module("onboarding").directive("problemsChecklist",["Authentication","Problems","$modal",function(Authentication,Problems,$modal,$translate){return{templateUrl:"/modules/problems/partials/problems-list.client.view.html",restrict:"E",scope:{ourUser:"="},link:function(scope,element,attrs){var newProblem=function(problem){var newProb={};return newProb.key=problem.key,newProb.title=problem.title,newProb.icon=problem.icon,newProb.issues=[],newProb.photos=[],newProb};Problems.getLocalFile().then(function(data){scope.problems=data,scope.ourUser.problems.forEach(function(userProb){var prob=scope.problems.getByKey(userProb.key);prob.numChecked=userProb.issues.length,userProb.issues.forEach(function(i){prob.issues.containsByKey(i.key)||prob.issues.push(i)})})}),scope.$parent.hasChangedProblems=!1,scope.open=function(problem){scope.currentProblem=problem,scope.ourUser.problems.containsByKey(problem.key)||scope.ourUser.problems.push(newProblem(problem));var ourUserCurrentProblem=scope.ourUser.problems.getByKey(problem.key),numIssuesOnModalOpen=ourUserCurrentProblem.issues.length,modalInstance=$modal.open({animation:"true",templateUrl:"modules/problems/partials/problem-modal.client.view.html",controller:"ModalProblemController",size:"md",scope:scope,backdrop:"static",resolve:{issues:function(){return scope.currentProblem.issues},userProblem:function(){return ourUserCurrentProblem}}});modalInstance.result.then(function(){scope.currentProblem.numChecked=ourUserCurrentProblem.issues.length,numIssuesOnModalOpen!=ourUserCurrentProblem.issues.length&&(scope.$parent.hasChangedProblems=!0),0==ourUserCurrentProblem.issues.length&&scope.ourUser.problems.removeByKey(ourUserCurrentProblem.key)},function(){0==ourUserCurrentProblem.issues.length&&scope.ourUser.problems.removeByKey(ourUserCurrentProblem.key)})}}}}]),angular.module("onboarding").directive("problemOtherItem",["$timeout","$filter",function($timeout,$filter){return{template:"",restrict:"A",link:function(scope,element,attrs){element.on("touchstart touchend",function(e){e.preventDefault(),e.stopPropagation()}),scope.addMore=!1,scope.toggleOther=function(event){event.preventDefault(),event.stopPropagation(),scope.addMore=!0,scope.newOther={key:"",emergency:!1},element.find("input")[0].focus(),$timeout(function(){var objDiv=document.querySelector(".selecter-options");objDiv.scrollTop=objDiv.scrollHeight})},scope.addOther=function(event){event.stopPropagation(),!scope.userProblem.issues.containsByKey(scope.newOther.key)&&scope.newOther.key.length&&(scope.newOther.key=$filter("titlecase")(scope.newOther.key),scope.issues.push(scope.newOther),scope.userProblem.issues.push(scope.newOther),scope.newOther={key:"",emergency:!1},scope.addMore=!1,$timeout(function(){var objDiv=document.querySelector(".selecter-options");objDiv.scrollTop=objDiv.scrollHeight}))}}}}]),angular.module("problems").filter("problemTitle",function(){return function(input){switch(input){case"bedrooms":return"Bedrooms";case"kitchen":return"Kitchen";case"bathroom":return"Bathrooms";case"entireHome":return"Entire Home";case"livingRoom":return"Living Room";case"publicAreas":return"Public Areas";case"landlordIssues":return"Landlord Issues";default:return""}}}),angular.module("onboarding").factory("ProblemsResource",["$resource","UpdateUserInterceptor",function($resource,UpdateUserInterceptor){return $resource("",{},{updateChecklist:{method:"PUT",url:"api/tenants/checklist",interceptor:UpdateUserInterceptor},updateManagedChecklist:{method:"PUT",url:"api/advocates/tenants/:id/checklist"}})}]).factory("Problems",["$http","$q","Authentication",function($http,$q,Authentication){var requestLocalFile=function(){var deferred=$q.defer();return $http.get("data/checklist.json").then(function(response){deferred.resolve(response.data)},function(err){deferred.reject(err)}),deferred.promise};return{getLocalFile:function(){return requestLocalFile()},getUserIssuesByKey:function(key){return Authentication.user.problems.getByKey(key).issues},getUserProblems:function(){for(var problems=[],i=0;i<Authentication.user.problems.length;i++)problems.push(Authentication.user.problems[i].title);return problems}}}]),angular.module("tutorial").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.when("/tutorial","/tutorial/intro"),$stateProvider.state("tutorial",{url:"/tutorial",templateUrl:"modules/tutorial/views/tutorial.client.view.html",abstract:!0,data:{disableBack:!0}}).state("tutorial.intro",{url:"/intro",templateUrl:"modules/tutorial/partials/intro.client.view.html"}).state("tutorial.main",{url:"/main",templateUrl:"modules/tutorial/partials/tutorial.client.view.html",globalStyles:"no-header-spacing white-bg"})}]),angular.module("tutorial").controller("TutorialController",["$scope","$sce","$translate",function($scope,$sce,$translate){var lang=$translate.use(),cdnUrl="https://degy28l8twq8c.cloudfront.net/tutorial/";$scope.slides=[{image:cdnUrl+"TakeAction-"+lang+".png",text:$sce.trustAsHtml("The more evidence you upload, the stronger your case will be. Start with the <strong>Take Action</strong> section to add photos, file 311 complaints and send notices to your landlord."),title:"Gather Evidence"},{image:cdnUrl+"StatusUpdate-"+lang+".png",text:$sce.trustAsHtml("Add a <strong>Status Update</strong> at any time from the dashboard. This will help you keep a log of any updates or communication with your landlord."),title:"Add Status Updates"},{image:cdnUrl+"CaseHistory-"+lang+".png",text:$sce.trustAsHtml("Everything you do is saved in your <strong>Case History</strong>. You can print it for housing court or share it with neighbors and advocates by using the Share Link."),title:"Share Your Case History"},{image:cdnUrl+"KYR-"+lang+".png",text:$sce.trustAsHtml("It's important to stay informed about your rights as a tenant. Go to <strong>Know Your Rights</strong> for articles and links to get more information."),title:"Know Your Rights"}]}]),angular.module("users").config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push(["$rootScope","$q","$location","$injector","Authentication",function($rootScope,$q,$location,$injector,Authentication){return{responseError:function(rejection){switch(rejection.status){case 401:Authentication.user=null,console.log("not logged in"),$injector.get("$state").transitionTo("signin");break;case 403:console.log("unauthorized or not found"),$injector.get("$state").transitionTo("not-found")}return $q.reject(rejection)}}}])}]).run(["$rootScope","$state","$location","$window","Authentication",function($rootScope,$state,$location,$window,Authentication){$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){"signin"===toState.name&&Authentication.user&&$location.path("/")})}]),angular.module("users").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.when("/settings","/settings/profile"),$stateProvider.state("settings",{url:"/settings",controller:"SettingsController",templateUrl:"modules/users/views/settings/settings.client.view.html",abstract:!0}).state("settings.profile",{url:"/profile",templateUrl:"modules/users/views/settings/landing.client.view.html",settings:!0}).state("settings.edit",{url:"/edit",templateUrl:"modules/users/views/settings/edit-profile.client.view.html",settings:!0}).state("settings.password",{url:"/password",templateUrl:"modules/users/views/settings/change-password.client.view.html",settings:!0}).state("settings.phone",{url:"/phone",templateUrl:"modules/users/views/settings/edit-phone.client.view.html",settings:!0}),$stateProvider.state("signin",{url:"/signin",templateUrl:"modules/users/views/authentication/signin.client.view.html"}).state("forgot",{url:"/password/forgot",templateUrl:"modules/users/views/password/forgot-password.client.view.html"}).state("reset-invalid",{url:"/password/reset/invalid",templateUrl:"modules/users/views/password/reset-password-invalid.client.view.html"}).state("reset-success",{url:"/password/reset/success",templateUrl:"modules/users/views/password/reset-password-success.client.view.html"}).state("reset",{url:"/password/reset/:token",templateUrl:"modules/users/views/password/reset-password.client.view.html"})}]),angular.module("users").controller("AuthenticationController",["$rootScope","$scope","$http","$state","$location","$timeout","Authentication",function($rootScope,$scope,$http,$state,$location,$timeout,Authentication){$scope.authentication=Authentication,$scope.signin=function(){$scope.error=void 0,$rootScope.loading=!0,$http.post("/api/auth/signin",$scope.credentials).success(function(response){switch($rootScope.loading=!1,$scope.authentication.user=response,response.roles[0]){case"admin":$state.go("admin");break;case"advocate":$state.go("advocateHome");break;case"tenant":$state.go("home");break;default:$state.go("home")}}).error(function(response){$timeout(function(){$rootScope.loading=!1,$scope.error=response.message},1e3)})},$scope.forgotPassword={},$scope.pwError=!1,$scope.pwSuccess=!1,$scope.requestPassword=function(){$scope.forgotPassword.phone?($scope.pwError=!1,$scope.pwSuccess=!0,Rollbar.info("Forgot Password",{phone:$scope.forgotPassword.phone})):($scope.pwError=!0,$scope.pwSuccess=!1)}}]),angular.module("users").controller("PasswordController",["$scope","$stateParams","$http","$location","Authentication",function($scope,$stateParams,$http,$location,Authentication){$scope.authentication=Authentication,$scope.authentication.user&&$location.path("/"),$scope.askForPasswordReset=function(){console.log($scope.credentials),$scope.success=$scope.error=null,$http.post("/api/auth/forgot",$scope.credentials).success(function(response){$scope.credentials=null,$scope.success=response.message}).error(function(response){$scope.credentials=null,$scope.error=response.message})},$scope.resetUserPassword=function(){$scope.success=$scope.error=null,console.log($stateParams),$http.post("/api/auth/reset/"+$stateParams.token,$scope.passwordDetails).success(function(response){$scope.passwordDetails=null,Authentication.user=response,$location.path("/api/password/reset/success")}).error(function(response){$scope.error=response.message})}}]),angular.module("users").controller("SettingsController",["$scope","$http","$location","$state","$filter","Users","Authentication","$rootScope",function($scope,$http,$location,$state,$filter,Users,Authentication,$rootScope){$scope.passwordVerified=!1,$scope.successfulUpdate=!1,$scope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){$scope.user=Authentication.user,console.log($scope.user),"settings.profile"===fromState.name&&($scope.successfulUpdate=!1)}),$scope.hasConnectedAdditionalSocialAccounts=function(provider){for(var i in $scope.user.additionalProvidersData)return!0;return!1},$scope.isConnectedSocialAccount=function(provider){return $scope.user.provider===provider||$scope.user.additionalProvidersData&&$scope.user.additionalProvidersData[provider]},$scope.removeUserSocialAccount=function(provider){$scope.success=$scope.error=null,$http.delete("api/users/accounts",{params:{provider:provider}}).success(function(response){$scope.success=!0,$scope.user=Authentication.user=response}).error(function(response){$scope.error=response.message})},$scope.signOut=function(){$http.get("api/auth/signout").then(function(success){},function(err){console.log(err)})},$scope.updateUserProfile=function(isValid){if(isValid){$scope.success=$scope.error=null;var user=new Users($scope.user);isValid?($scope.userError=!1,$rootScope.loading=!0,user.$update(function(response){$rootScope.loading=!1,$scope.user=Authentication.user,$state.go("settings.profile"),$scope.passwordVerified=!1,$scope.successfulUpdate=!0},function(err){$rootScope.loading=!1,console.log(err),$scope.error=err})):$scope.userError=!0}},$scope.updateUserPhone=function(isValid){if(isValid){$scope.success=$scope.error=null;var user=new Users($scope.user);isValid?($scope.userError=!1,$rootScope.loading=!0,user.$updatePhone(function(response){$rootScope.loading=!1,$scope.user=Authentication.user,$state.go("settings.profile"),$scope.passwordVerified=!1,$scope.successfulUpdate=!0},function(err){$rootScope.loading=!1,console.log(err),$scope.error=err})):$scope.userError=!0}},$scope.changeUserPassword=function(){$scope.success=$scope.error=null,$http.post("api/users/password",$scope.passwordDetails).success(function(response){$scope.success=!0,$scope.passwordDetails=null,$state.go("settings.profile")}).error(function(response){$scope.error=response.message})},$scope.verifyPassword=function(password){$http.post("api/users/verify-password",{password:password}).success(function(response){$scope.passwordVerified=!0,$scope.user.phone=""}).error(function(err){$scope.passwordError=!0,$scope.errorMessage=err.message})}}]),angular.module("core").directive("toggleSharing",["Users","Authentication",function(Users,Authentication){
return{restrict:"A",scope:!1,link:function(scope,elm,attrs){Authentication.user&&Authentication.user.sharing.enabled&&(elm[0].querySelector("input").checked=!0),scope.$parent.newUser&&scope.$watch("$parent.newUser",function(newUser){newUser.sharing.enabled?elm[0].querySelector("input").checked=!0:elm[0].querySelector("input").checked=!1}),elm.bind("touchstart click",function(event){event.stopPropagation(),event.preventDefault(),elm[0].querySelector("input").checked=!elm[0].querySelector("input").checked,Authentication.user?Users.toggleSharing(function(user){Authentication.user=user}):scope.newUser&&(scope.newUser.sharing.enabled=elm[0].querySelector("input").checked,scope.$apply())})}}}]),angular.module("users").factory("Authentication",[function($resource){var _this=this;return _this._data={user:window.user},_this._data}]),angular.module("users").factory("UpdateUserInterceptor",["Authentication",function(Authentication){return{response:function(res){return Authentication.user=res.resource,res}}}]),angular.module("users").factory("Users",["$resource","UpdateUserInterceptor",function($resource,UpdateUserInterceptor){return $resource("api/users",{},{me:{url:"api/users/me",interceptor:UpdateUserInterceptor},update:{method:"PUT",interceptor:UpdateUserInterceptor},updatePhone:{method:"PUT",url:"api/users/phone",interceptor:UpdateUserInterceptor},toggleSharing:{method:"GET",url:"api/tenants/public"},getScheduledEventInfo:{method:"GET",url:"api/acuity"}})}]);
//# sourceMappingURL=application.min.js.map